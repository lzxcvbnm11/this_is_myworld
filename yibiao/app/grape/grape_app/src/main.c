/* **************************************************************************** PROJECT : GRAPE_APP FILE : $Id: main.c 5378 2015-06-30 09:17:52Z florian.zimmermann $ AUTHOR : $Author: annabelle.agez $ ============================================================================ DESCRIPTION GRAPE (Graphics Application Environment) Application Note ============================================================================ C O P Y R I G H T ============================================================================ Copyright (c) 2012 by Renesas Electronics (Europe) GmbH. Arcadiastrasse 10 D-40472 Duesseldorf Germany All rights reserved. ============================================================================ Purpose: only for testing  DISCLAIMER This software is supplied by Renesas Electronics Corporation and is only intended for use with Renesas products. No other uses are authorized. This software is owned by Renesas Electronics Corporation and is protected under all applicable laws, including copyright laws. THIS SOFTWARE IS PROVIDED "AS IS" AND RENESAS MAKES NO WARRANTIES REGARDING THIS SOFTWARE, WHETHER EXPRESS, IMPLIED OR STATUTORY, INCLUDING BUT NOT LIMITED TO WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. ALL SUCH WARRANTIES ARE EXPRESSLY DISCLAIMED. TO THE MAXIMUM EXTENT PERMITTED NOT PROHIBITED BY LAW, NEITHER RENESAS ELECTRONICS CORPORATION NOR ANY OF ITS AFFILIATED COMPANIES SHALL BE LIABLE FOR ANY DIRECT, INDIRECT, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES FOR ANY REASON RELATED TO THIS SOFTWARE, EVEN IF RENESAS OR ITS AFFILIATES HAVE BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES. Renesas reserves the right, without notice, to make changes to this software and to discontinue the availability of this software. By using this software, you agree to the additional terms and conditions found by accessing the following link: http://www.renesas.com/disclaimer * Copyright (C) 2011 Renesas Electronics Corporation. All rights reserved.   **************************************************************************** */  /*********************************************************** Title: Main Module  This module contains the main and the main loop functions. */  /*********************************************************** Section: Includes */  #include "r_typedefs.h" #include "r_cdi_api.h"  #include "fw_clibal_api.h" #include "fw_boal_api.h" #include "fw_osal_api.h" #include "fw_vovial_api.h" #include "fw_hmial_api.h" #include "fw_fsal_api.h" #include "r_drw2d_api.h"   #ifdef R_DRW2D_SYS_DHD #include "davehd_driver.h" #include "r_util_dhd.h" #endif #include "r_dev_api.h" #include "img_format.h" #include "romfs_api.h" #include "font.h" #include "img_data.h" #include "fs_data.h" #include "application.h" #include "error.h" #include "r_config_d1x.h"  #include "public.h" #define _MAIN_GLOBALS_ #include "main.h" #include "mem_init.h"  #include "wm.h" #include <strings.h>  #include "com_public.h" #include "sys_public.h" #include "bpm_public.h" #include "dio_public.h"  #include "r_typedefs.h" /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr Renesas basic types, e.g. uint32_t */ #include "r_bsp_api.h" /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr Board support package */ #include "r_ddb_api.h" #include "r_cdi_api.h" #include "r_wm_api.h"   #include "config.h" #include "r_drw2d_os.h" #include "r_drw2d_api.h" #include "r_config_drw2d.h" #include "r_drw2d_ctx_cpu.h"  #include "r_config_vdce.h" #include "r_vdce_api.h" #include "r_spea_api.h"  #include "r_tick_api.h" #include "r_bsp_stdio_api.h" #include <string.h>  #include "hmi_manager.h" #include "hmi_reset.h" //#include "Hmi_loop.h"  #include "dio_public.h" #include "com_public.h" #include "wdt_public.h" #include "sys_public.h" #include "rtc_public.h" #include "nvm_public.h" #include "illu_public.h" #include "bat_public.h" #include "crus_public.h" #include "stsmg_public.h"  #include "trip_public.h" #include "st_public.h" #include "tip_public.h" #include "odo_public.h" #include "acc_public.h" #include "pwr_public.h" #include "ssb_public.h" #include "ass_public.h" #include "scs_public.h" #include "led_public.h" #include "msg_public.h" #include "idle_public.h"  #include "com_public.h" #include "bat_public.h"   #include "hsd_public.h" #include "rst_public.h"  #include "ostm_public.h"  #include "avgFuelCsump_V2.h" #include "FuelLevelAlgorithm_V2.h" #include "RangeToEmptyAlgorithm_V2.h" extern void hmi_gfx_loop(float dt);  //#define USE_LRAM_FB /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr bitmap width */ #define LOC_BMP_W (30) /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr bitmap height */ #define LOC_BMP_H (30) /*********************************************************** Section: Local Defines */  /*********************************************************** Define: LOC_BACKGROUND_STACKSIZE  Stack size of the background thread. */ #define LOC_BACKGROUND_STACKSIZE 0x500   /*********************************************************** Define: LOC_BACKGROUND_PRIO  Priority of the background thread. */  #define LOC_BACKGROUND_PRIO 0x20   /*********************************************************** Define: LOC_MAINLOOP_STACKSIZE  Stack size of the main loop thread. */  #define LOC_MAINLOOP_STACKSIZE 0x1000 #define LOC_HMIGFXLOOP_STACKSIZE 0x1000   /*********************************************************** Define: LOC_MAINLOOP_PRIO  Priority of the main loop thread. */  #define LOC_MAINLOOP_PRIO 0x24 #define LOC_HMIGFXLOOP_PRIO 0x23   /*********************************************************** Define: LOC_TIME_BASE  Time in MS to measure the CPU performance. */  #define LOC_TIME_BASE 200   /*********************************************************** Define: LOC_PERF_PCT  Multiplier to change to % */  #define LOC_PERF_PCT 100  /*********************************************************** Section: Local Variables */  /*********************************************************** Variable: locStackBackGroundThread  Stack of the background thread. */  //static uint32_t locStackBackGroundThread[LOC_BACKGROUND_STACKSIZE >> 2];   /*********************************************************** Variable: locStackMainLoopThread  Stack of the main loop thread. */  static uint32_t locStackMainLoopThread[LOC_MAINLOOP_STACKSIZE>>2]; static uint32_t locStackHMIGfxLoopThread[LOC_HMIGFXLOOP_STACKSIZE>>2];  /*********************************************************** Variable: locSignalSema  Semaphore to indicate availability of a command. */  static fw_osal_Sema_t locSignalSema; static fw_osal_Mutex_t lochmimuteSema;    static char locHMIGfxFinish;  /*********************************************************** Signal application exit. */  #ifdef USE_LRAM_FB //r_cdi_Heap_t loc_VOVIALRAM_heap; static uint8_t locFrameBufferLRAM[(LOC_DISPLAY_STRIDE app_drw2dcpu app_menu app_tripcomp app_tutorial application.c application.h error.c error.h font.h font_data.h fonts fs_data.h hmi_manager.c hmi_manager.h img.c img.h img_data.h img_drw2d.c img_drw2d.h img_format.h main.c main.h mem_init.c mem_init.h sfma.c wm.c wm.h write.c write.h LOC_DISPLAY_HEIGHT app_drw2dcpu app_menu app_tripcomp app_tutorial application.c application.h error.c error.h font.h font_data.h fonts fs_data.h hmi_manager.c hmi_manager.h img.c img.h img_data.h img_drw2d.c img_drw2d.h img_format.h main.c main.h mem_init.c mem_init.h sfma.c wm.c wm.h write.c write.h LOC_DISPLAY_BPP app_drw2dcpu app_menu app_tripcomp app_tutorial application.c application.h error.c error.h font.h font_data.h fonts fs_data.h hmi_manager.c hmi_manager.h img.c img.h img_data.h img_drw2d.c img_drw2d.h img_format.h main.c main.h mem_init.c mem_init.h sfma.c wm.c wm.h write.c write.h 2 + 0x1000)] __attribute__((aligned(128))); #endif HMI_Page_ENUM mainPage = PAGE_HMI_Version;  static struct r_drw2d_DeviceCPU_s loc_CPUDrwDev; r_drw2d_Device_t loc_Drw2dDev; extern r_cdi_Heap_t loc_lRAM_heap; extern r_cdi_Heap_t loc_VRAM_heap;   r_drw2d_Device_t* hmi_get_rgl_drw2dDevice(void) { return (&loc_Drw2dDev); }  void app_drw2dcpu app_menu app_tripcomp app_tutorial application.c application.h error.c error.h font.h font_data.h fonts fs_data.h hmi_manager.c hmi_manager.h img.c img.h img_data.h img_drw2d.c img_drw2d.h img_format.h main.c main.h mem_init.c mem_init.h sfma.c wm.c wm.h write.c write.h hmi_get_rgl_deviceInternal(void) { return (NULL); }   /*local ram 指针和video ram 指针*/ r_cdi_Heap_t app_drw2dcpu app_menu app_tripcomp app_tutorial application.c application.h error.c error.h font.h font_data.h fonts fs_data.h hmi_manager.c hmi_manager.h img.c img.h img_data.h img_drw2d.c img_drw2d.h img_format.h main.c main.h mem_init.c mem_init.h sfma.c wm.c wm.h write.c write.h hmi_get_CPU_heap(void) { return (&loc_lRAM_heap); } r_cdi_Heap_t app_drw2dcpu app_menu app_tripcomp app_tutorial application.c application.h error.c error.h font.h font_data.h fonts fs_data.h hmi_manager.c hmi_manager.h img.c img.h img_data.h img_drw2d.c img_drw2d.h img_format.h main.c main.h mem_init.c mem_init.h sfma.c wm.c wm.h write.c write.h hmi_get_video_heap(void) { return (&loc_VRAM_heap); }  static r_drw2d_Boolean_t loc_DRW2DErrorHandler(r_drw2d_Error_t Error, void *UserData) { loc_Error(1); return R_TRUE; }  static void *locHMIGfxLoop(void app_drw2dcpu app_menu app_tripcomp app_tutorial application.c application.h error.c error.h font.h font_data.h fonts fs_data.h hmi_manager.c hmi_manager.h img.c img.h img_data.h img_drw2d.c img_drw2d.h img_format.h main.c main.h mem_init.c mem_init.h sfma.c wm.c wm.h write.c write.h Arg) { int32_t ret = R_DRW2D_ERR_OK;  loc_SetupMemManager(); loc_InitWM(&loc_lRAM_heap, &loc_VRAM_heap); R_WM_FrameEndMark(LOC_WM_UNIT, 0); R_WM_FrameWait(LOC_WM_UNIT, 0); /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr start up gfx engine */ ret |= R_DRW2D_Init(); ret |= R_DRW2D_GlobalErrCallbackSet(&loc_DRW2DErrorHandler, R_NULL); ret |= R_DRW2D_Open(LOC_DRW2D_UNIT, R_DRW2D_UNIT_DHD0, &loc_CPUDrwDev, &loc_Drw2dDev);  mainPage = PAGE_HMI_WARN; hmi_init();  FW_OSAL_ThreadSleep(50);   FW_CLIBAL_PrintF("grape_app: locHMIGfxLoop\n");  while(1) {  hmi_gfx_loop(0.1);  locHMIGfxFinish = 1; } }    /*********************************************************** Function: locMainLoop  The application main loop.  This thread waits for commands sent by other threads and executes them.  Parameters: Arg - Thread parameter (not used).  Returns: void */  static void *locMainLoop(void app_drw2dcpu app_menu app_tripcomp app_tutorial application.c application.h error.c error.h font.h font_data.h fonts fs_data.h hmi_manager.c hmi_manager.h img.c img.h img_data.h img_drw2d.c img_drw2d.h img_format.h main.c main.h mem_init.c mem_init.h sfma.c wm.c wm.h write.c write.h Arg) { //uint32_t err;  //char active; //U32 timeStart; //U32 timeEnd; #if OSTM_TEST_PRIEOD U32 loc_TickTime; U8 res; #endif  //FW_OSAL_ThreadCreate(locBackGroundThread, 0, locStackBackGroundThread, // LOC_BACKGROUND_STACKSIZE, LOC_BACKGROUND_PRIO); FW_OSAL_ThreadCreate(locHMIGfxLoop, 0, locStackHMIGfxLoopThread, LOC_HMIGFXLOOP_STACKSIZE, LOC_HMIGFXLOOP_PRIO);  // FW_CLIBAL_Init(); // FW_BOAL_OsLevelInit(); //FW_HMIAL_Init();  //FW_FSAL_Init(&RomFileSystemData[0]);  //err = locCheckRomFS(); //if (err) //{ // Error(ERR_FILESYSTEM_BROKEN); //}  //err = locCheckFlashFS(); //if (err) //{ // FW_CLIBAL_PrintF("Flash section of ROM file system not available.\n"); //} WDT_Init();  FW_OSAL_ThreadSleep(50); //active = AppNum - 1; //(AppList[AppNum - 1]->Init)(); //FW_HMIAL_SetControl(AppList[(AppNum - 1)]->Control); //locConfirmFlag = 1; //locQuit = 0; //MOM_SetToZero(); FW_CLIBAL_PrintF("grape_app: locMainLoop\n");  while (1) {  #if OSTM_TEST_PRIEOD loc_TickTime++; if ((loc_TickTime % 2) == 0) //测试1ms的准确性 { DIO_SetIOSts(INDEX_DIO_PIN88, 0, &res); } else { DIO_SetIOSts(INDEX_DIO_PIN88, 1, &res); } #endif  SYS_ProcessManage(); FW_OSAL_ThreadSleep(3);  }  FW_VOVIAL_DeInit(0); FW_HMIAL_DeInit(); FW_BOAL_OsLevelDeInit(); FW_CLIBAL_DeInit(); return 0; }    /*********************************************************** Function: main  Initialize the board, OS and create the main thread */  int main(void) { int32_t i, ret = R_DRW2D_ERR_OK;  FW_BOAL_LowLevelInit();   loc_StartSFMA();  #ifdef R_DRW2D_SYS_DHD R_UTIL_DHD_Init(0); R_UTIL_DHD_Config((dhd_gpu_ptr_t)loc_DHD_BASE, DHD_MEMORY_SIZE, &loc_lRAM_heap); #endif //FW_OSAL_MutexCreate(&lochmimuteSema); //FW_OSAL_SemaCreate(&locSignalSema);  FW_OSAL_InitOS();  FW_OSAL_ThreadCreate(locMainLoop, 0, locStackMainLoopThread, LOC_MAINLOOP_STACKSIZE, LOC_MAINLOOP_PRIO);  FW_OSAL_StartOS(); FW_BOAL_LowLevelDeInit(); /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr Depending on the OS, you may never get here */ return 0; }   void loc_Error(int32_t Err) { while (Err) { } }  void Signal_SemaCreate(void) { FW_OSAL_SemaCreate(&locSignalSema); return; }  char GetHMIGfxFinish(void) { char res =FALSE;  if (locHMIGfxFinish) { locHMIGfxFinish =0; res =TRUE; }  return(res); }
