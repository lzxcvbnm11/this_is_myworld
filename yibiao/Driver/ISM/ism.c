 /***************************************************************************** ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Copyright (C) 2016 ShenZhen Yeedon Media co.,LTD. All rights reserved. * ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h File Name : ISM.C ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Description :the private datas of the pwmm module. ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Author: LIUYINGYING ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Date: 2017-09-24 ******************************************************************************/ /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr Files for including */ #include "ism_info.inc"   /*******************************************/ static U8 Ism_Init = RET_FAIL; static U8 ZPDHasDone = FALSE; static U32 zerostarttime = 0; unsigned char g_deviceID=0; unsigned char g_ISMZPDStep=0; static U32 runangle[6]={-1,-1,-1,-1,-1,-1};  static struct r_ism_t *rism_p[ R_ISM_MACRO_NUM ] = { ( r_ism_t ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h )( R_ISM_MACRO_BASE0 ) };    /*************************************************** ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Function: ISM_Init ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Description: the initialized of the ISM module ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Parameters: none ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Returns: none ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h $Create & Verlog:$ ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Author:liuyingyign Date:2017-09-25 Version:V2.0 ****************************************************/ void ISM_Init(void) { uint32_t pclk_Hz; #if CLOSE_MOTOR Ism_Init =FALSE; #endif /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr initialize the ISM PCLK clock */ pclk_Hz = R_SYS_ISM_SysSetClockHz(R_ISM_UNIT, (80 ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h 1000 ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h 1000)); /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr initialize the ports */ R_SYS_ISM_SetPort(R_ISM_UNIT); R_ISM_SetMotor_CONTI2000( 0 );   /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr ZPD */ /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr the problem with the current code is it hangs on until ZPD is done */ R_ISM_Reset( R_ISM_UNIT );  R_ISM_DownloadCMParamset( R_ISM_UNIT, R_ISM_CHANNEL_EN0 | R_ISM_CHANNEL_EN4 );  R_ISM_SetupCMChannel( R_ISM_UNIT, R_ISM_CHANNEL_EN0 | R_ISM_CHANNEL_EN4, /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr all configured channels */ 1 ); /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr clear target position */  Ism_Init =TRUE; }   /*************************************************** ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Function: ISM_setDeviceID ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Description: set device id ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Parameters: input : id  ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Returns: none ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h $Create & Verlog:$ ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Author:liuyingyign Date:2017-09-25 Version:V2.0 ****************************************************/ void ISM_setDeviceID(unsigned char ID) { g_deviceID = ID-1; if(6 <= g_deviceID) { g_deviceID = 0; } else { } //printf("g_deviceID = %d\n",ID); }   /*************************************************** ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Function: ISM_GetInitStatus ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Description: Get ISM Init Status ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Parameters: none ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Returns: none ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h $Create & Verlog:$ ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Author:liuyingyign Date:2017-09-25 Version:V2.0 ****************************************************/ U8 ISM_GetInitStatus(void) { return Ism_Init; }   #if USE_RECORRECTION_METHOD /*************************************************** ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Function: ism_angleCorrection ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Description: set correction angle ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Parameters: channel:input speed or tacho  angle : input correction angle ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Returns: none ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h $Create & Verlog:$ ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Author:liuyingyign Date:2017-09-25 Version:V2.0 ****************************************************/ uint32_t ism_angleCorrection(unsigned char channel,uint32_t angle) { uint32_t res,i,ofs1,ofs2,tmp1,tmp2;  ofs1 = 0; ofs2 = 0; if(channel == 4) { for(i=0;i<6;i++) { if(angle <= ANGLECOLLECTPOINT_4[i]) { tmp1 = ANGLECOLLECTPOINT_4[i] - ofs1; tmp2 = ANGLECOLLECTTBL_4[g_deviceID][i] - ofs2; res = tmp2*(angle-ofs1)/tmp1; res += ofs2; break; } ofs1 = ANGLECOLLECTPOINT_4[i]; ofs2 = ANGLECOLLECTTBL_4[g_deviceID][i]; } } else if(channel == 0) { for(i=0;i<8;i++) { if(angle <= ANGLECOLLECTPOINT_0[i]) { tmp1 = ANGLECOLLECTPOINT_0[i] - ofs1; tmp2 = ANGLECOLLECTTBL_0[g_deviceID][i] - ofs2; res = tmp2*(angle-ofs1)/tmp1; res += ofs2; break; } else { } ofs1 = ANGLECOLLECTPOINT_0[i]; ofs2 = ANGLECOLLECTTBL_0[g_deviceID][i]; } } else { res = angle*0x4000/12; }  return res; }  /*************************************************** ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Function: ism_getCorrentionAngle ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Description: Get Angle ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Parameters: ch:input channel speed or tacho ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Returns: none ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h $Create & Verlog:$ ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Author:liuyingyign Date:2017-09-25 Version:V2.0 ****************************************************/ uint32_t ism_getCorrentionAngle(unsigned char ch) { uint32_t i,tmp,res,ofs1,ofs2,tmp1,tmp2;  if(TRUE == ISM_GetWorkStatus(ch)) { return runangle[ch]; } else { } tmp = rism_p[0]->var[ch].position; ofs1 = ofs2 = 0; if(ch == 4) { for(i=0;i<6;i++) {  if(tmp <= ANGLECOLLECTTBL_4[g_deviceID][i]) { tmp1 = (ANGLECOLLECTMOVE_4[i] - ofs1)>>8; tmp2 = (ANGLECOLLECTTBL_4[g_deviceID][i] - ofs2)>>8; res = tmp1*((tmp>>8)-ofs2)/tmp2; res += ofs1; break; }  else { } ofs1 = ANGLECOLLECTMOVE_4[i]>>8; ofs2 = ANGLECOLLECTTBL_4[g_deviceID][i]>>8; } } else if(ch == 0) { for(i=0;i<6;i++) {  if(tmp <= ANGLECOLLECTTBL_0[g_deviceID][i]) { tmp1 = (ANGLECOLLECTMOVE_0[i] - ofs1)>>8; tmp2 = (ANGLECOLLECTTBL_0[g_deviceID][i] - ofs2)>>8; res = tmp1*((tmp>>8)-ofs2)/tmp2; res += ofs1; break; }  else { } ofs1 = ANGLECOLLECTMOVE_0[i]>>8; ofs2 = ANGLECOLLECTTBL_0[g_deviceID][i]>>8; } } else { return (((rism_p[0]->var[ch].position&0x00FFFF00)>>8))/64; } return res*3/16; } #endif  /*************************************************** ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Function: ISM_Move_Motors ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Description: Get ISM Init Status ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Parameters: channel:input speed or tacho angle:input dest angle ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Returns: none ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h $Create & Verlog:$ ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Author:liuyingyign Date:2017-09-25 Version:V2.0 ****************************************************/ void ISM_Move_Motors(uint8_t channel, uint32_t angle) { uint8_t CurrentChannel_u08; uint32_t TargetPositionRange_u32[R_ISM_CHANNELS]; uint32_t CurTargetPosition_u32[R_ISM_CHANNELS];  #if CLOSE_MOTOR return; #endif if(runangle[channel] == angle) { return; } else { } runangle[channel] = angle; rism_p[ 0 ]->gstc.clre = 0x3F; rism_p[ 0 ]->gstc.cldo = 1; /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr get the range of the stepper motors */ CurrentChannel_u08 = channel;  CurTargetPosition_u32[CurrentChannel_u08] = ism_angleCorrection(channel,angle); R_ISM_SetCMTargetPos(R_ISM_UNIT, CurrentChannel_u08, CurTargetPosition_u32[CurrentChannel_u08]);  }   /*************************************************** ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Function: ISM_StartZpd ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Description: start to Zero Position Detect ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Parameters: ismIndex ism channel index ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Returns: none ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h $Create & Verlog:$ ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Author:liuyingyign Date:2017-09-25 Version:V2.0 ****************************************************/ U8 ISM_StartZpd(U8 ismIndex,U8 islittle) { #if CLOSE_MOTOR return TRUE; #endif  *(unsigned int*)&rism_p[ 0 ]->gcfg = 0x00000000; switchIOPort(1); if(islittle) {  rism_p[ 0 ]->ccmr[ 0 ].cct = 0; rism_p[ 0 ]->ccmr[ 4 ].cct = 0; R_TICK_WaitMS(0,20); } else { rism_p[ 0 ]->ccmr[ 0 ].cct = 0; rism_p[ 0 ]->ccmr[ 4 ].cct = 0; R_TICK_WaitMS(0,2);  } M_ISM_ZPDCMChannel(R_ISM_UNIT,ismIndex); ZPDHasDone = FALSE;  g_ISMZPDStep = 0; zerostarttime = R_TICK_GetTimeMS(0); return TRUE; }    /*************************************************** ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Function: ISM_StopZpd ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Description: Stop Zero Position Detect ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Parameters: none ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Returns: TRUE ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h $Create & Verlog:$ ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Author:liuyingyign Date:2017-09-25 Version:V2.0 ****************************************************/ U8 ISM_StopZpd(void) { #if CLOSE_MOTOR return TRUE; #endif rism_p[ 0 ]->ccmr[0].czp = 0; rism_p[ 0 ]->ccmr[4].czp = 0; ZPDHasDone = TRUE; rism_p[ 0 ]->ccmr[ 0 ].cct = 0; rism_p[ 0 ]->ccmr[ 4 ].cct = 0; R_ISM_SetupCMChannel( R_ISM_UNIT, R_ISM_CHANNEL_EN0 | R_ISM_CHANNEL_EN4,1 ); *(unsigned int*)&rism_p[ 0 ]->gcfg = 0x0002002c; return TRUE; }  /*************************************************** ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Function: ISM_isZPDFinish ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Description: Get ZPD status ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Parameters: ismIndex: ism channel ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Returns: 0:TRUE 1:FALSE ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h $Create & Verlog:$ ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Author:liuyingyign Date:2017-09-25 Version:V2.0 ****************************************************/ U8 ISM_isZPDFinish(U8 ismIndex,U8 islittlezpd) { U8 ret = FALSE;  U32 timeinterval,ofs;  unsigned int tmp=0;  if(zerostarttime) { ret = FALSE;  ofs = (R_TICK_GetTimeMS(0) -zerostarttime); if(islittlezpd) { timeinterval = ZEROLITTLETIMEINTERVAL;  } else { timeinterval = ZEROTIMEINTERVAL; if(ofs >= ZEROTIMESTEP1) { tmp = 1; } else { } if(g_ISMZPDStep != tmp) { g_ISMZPDStep = tmp; switch(tmp) { case 1: rism_p[ 0 ]->ccmr[ 0 ].cct = 2; rism_p[ 0 ]->ccmr[ 4 ].cct = 2; break; case 2: default: break; } } else { } }   if(timeinterval <= ofs) { ret = TRUE; zerostarttime = 0; } else { } } else { ret = TRUE; } return ret; }   /*************************************************** ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Function: ISM_GetWorkStatus ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Description: Get motor work status ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Parameters: ismIndex: ism channel ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Returns: TRUE OR FALSE ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h $Create & Verlog:$ ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Author:liuyingyign Date:2017-09-25 Version:V2.0 ****************************************************/ U8 ISM_GetWorkStatus(U8 ismIndex) { uint32_t tar,act;  tar = (rism_p[ 0 ]->set.ch[ ismIndex].target & 0x00FFFF00); act = (rism_p[ 0 ]->var[ismIndex].position & 0x00FFFF00);  if(rism_p[ 0 ]->var[ismIndex].position & 0x00FF) { act += 0x100; } else { } if(tar == act)  { return TRUE; } else { return FALSE; } }   /*************************************************** ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Function: ISM_SetWorkMode ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Description: Set motor work status ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Parameters: ismIndex: ism channel ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Returns:  RET_FAIL RET_OK  ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h $Create & Verlog:$ ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Author:liuyingyign Date:2017-09-25 Version:V2.0 ****************************************************/ U8 ISM_SetWorkMode(MOMWorkStatus_ENUM mode) { U8 ret = RET_OK; if(TRUE == Ism_Init) { switch (mode)  { case MOTOR_NORMAL: R_ISM_ResetCMChannel(0); break; case MOTOR_SELF_CHECKING: R_ISM_ResetCMChannel(1); break; case MOTOR_TOZERO:  ISM_StartZpd(R_ISM_CHANNEL_EN0 | R_ISM_CHANNEL_EN4,FALSE);  break; } } else { ret = RET_FAIL; } return ret; }  /*************************************************** ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Function: ISM_GetCurAngle ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Description: get pointer angle ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Parameters: ch: input ism channel pAngle:output angle ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Returns:  RET_FAIL RET_OK  ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h $Create & Verlog:$ ism.c ism.mk ism_cfg.h ism_info.inc ism_private.h ism_public.h ism_src qlapbismv1.h qlapbismv1_a.c qlapbismv1_p.c qlapbismv1_p.h qlapbismv1_s.c r_ism_api.h r_ism_sys.h standardports_p.c standardports_p.h Author:liuyingyign Date:2017-09-25 Version:V2.0 ****************************************************/ U8 ISM_GetCurAngle(uint8_t ch,PU32 pAngle) { static U16 rpangle[6]={0,0,0,0,0,0}; U16 angle = 0; U8 res = RET_FAIL; if(NULL_PTR == pAngle) { return res; } else { } if(6 > ch) {  *pAngle = ism_getCorrentionAngle(ch);  res = RET_OK; } else { } return res; }
