 /************************************************************************** | Copyright |------------------------------------------------------------------------ |Copyright(c) by YEEDON MultiMedia Co.LTD. All rights reserved. | | this software if furnished under a license and may be used and copied | only in accordance with the terms of such license and with the inclusion | of he above copyright notic.This software or any other copies thereof | may not be provided of otherwise made available to any other persion. | No title to and ownership of the software is hereby transferred. | | the information in this software is subject to change without notice | and should not be construed as a commitment by | YEEDON MultiMedia Co.LTD. | | YEEDON MultiMedia Co.LTD. assumes no responsibility for the use or reliability | of its Software on equipment which is not supported by YEEDON MultiMedia Co.LTD. |-------------------------------------------------------------- **************************************************************************/    /*-----------------------------------------------------------------------*/ /*----Description of file-----------------------------------------------------*/ /*-----------------------------------------------------------------------*/    /************************************************************************* TPMS *************************************************************************/   /*------------------------------------------------------------------------*/ /*-----Head of file----------------------------------------------------------*/ /*------------------------------------------------------------------------*/ #include "tpms_info.inc"  /*==========variables=================*/ static U16 tpms_NetFLTirePrs = 0; static U8 tpms_NetFLTirePrsV = 0; static U8 tpms_NetFLTireSts = 0; static S16 tpms_NetFLTireTem = 0; static U8 tpms_NetFLTireTemV = 0; static U16 tpms_NetFRTirePrs = 0; static U8 tpms_NetFRTirePrsV = 0; static U8 tpms_NetFRTireSts = 0; static S16 tpms_NetFRTireTem = 0; static U8 tpms_NetFRTireTemV = 0; static U16 tpms_NetRLTirePrs = 0; static U8 tpms_NetRLTirePrsV = 0; static U8 tpms_NetRLTireSts = 0; static S16 tpms_NetRLTireTem = 0; static U8 tpms_NetRLTireTemV = 0; static U16 tpms_NetRRTirePrs = 0; static U8 tpms_NetRRTirePrsV = 0; static U8 tpms_NetRRTireSts = 0; static S16 tpms_NetRRTireTem = 0; static U8 tpms_NetRRTireTemV = 0; static U8 tpms_NetClstrDspdFLTirePrs = 0; static U8 tpms_NetClstrDspdFRTirePrs = 0; static U8 tpms_NetClstrDspdRRTirePrs = 0; static U8 tpms_NetClstrDspdRLTirePrs = 0; static BOOL tpms_NetClstrDspdFLTireSts = 0; static BOOL tpms_NetClstrDspdFRTireSts = 0; static BOOL tpms_NetClstrDspdRRTireSts = 0; static BOOL tpms_NetClstrDspdRLTireSts = 0; static U8 tpms_NetFICMDistUntAdj = 0; static U8 tpms_NetFICMFuelCsumpUntAdj = 0; static U8 tpms_NetFICMTemUntAdj = 0; static U8 tpms_NetFICMTyrePressureUntAdj = 0; static BOOL tpms_NetFICMDistUnitAdjtReqA = FALSE; static BOOL tpms_NetFICMFuelCsumpUntAdjARA= FALSE; static BOOL tpms_NetFICMTemUntAdjtReqA = FALSE; static BOOL tpms_NetFICMTyrePressureUntAdjtReqA = FALSE; static U8 tpms_NetClstrDistUnt = 0; static U8 tpms_NetClstrFuelCsumpUnt = 0; static U8 tpms_NetClstrTemUnt = 0; static U8 tpms_NetClstrTyrePressureUnt = 0; static U8 insTyrePresUnitsPrm = 0; static U8 insDistanceUnitsPrm = 0; static U8 insFuelConUnitsPrm = 0; static U8 insTempUnitsPrm = 0;   static U8 tpms_InitSts = FALSE; static TPMS_WarnType_ST tpmsWrnngStatus; static U8 tpms_Process100MsPRO = 0;  /************************************************** *Function :TPMS_Init *Description: TPMS Module Inital *Parameters:none *Returns: none **create&Verlog: *Author Name xs Date:2017-6-23 Ver:01 ***************************************************/ void TPMS_Init(void) { tpms_InitSts = FALSE;  tpms_NetFLTirePrs = 0; tpms_NetFLTirePrsV = 0; tpms_NetRLTireSts = 0; tpms_NetFLTireTem = 0; tpms_NetFLTireTemV = 0; tpms_NetFRTirePrs = 0; tpms_NetFRTirePrsV = 0; tpms_NetFRTireSts = 0; tpms_NetFRTireTem = 0; tpms_NetFRTireTemV = 0; tpms_NetRLTirePrs = 0; tpms_NetRLTirePrsV = 0; tpms_NetRLTireSts = 0; tpms_NetRLTireTem = 0; tpms_NetRLTireTemV = 0; tpms_NetRRTirePrs = 0; tpms_NetRRTirePrsV = 0; tpms_NetRRTireSts = 0; tpms_NetRRTireTem = 0; tpms_NetRRTireTemV = 0; tpms_NetClstrDspdFLTirePrs = 0; tpms_NetClstrDspdFRTirePrs = 0; tpms_NetClstrDspdRRTirePrs = 0; tpms_NetClstrDspdRLTirePrs = 0; tpms_NetClstrDspdFLTireSts = 0; tpms_NetClstrDspdFRTireSts = 0; tpms_NetClstrDspdRRTireSts = 0; tpms_NetClstrDspdRLTireSts = 0;  tpms_Process100MsPRO = 0;  insTyrePresUnitsPrm = DIAG_GetTyrePresUnits(); insDistanceUnitsPrm = DIAG_GetDistanceUnits(); insFuelConUnitsPrm = DIAG_GetFuelConUnits(); insTempUnitsPrm = DIAG_GetTempUnits();  tpms_NetClstrDistUnt = insTyrePresUnitsPrm; tpms_NetClstrFuelCsumpUnt = insDistanceUnitsPrm; tpms_NetClstrTemUnt = insFuelConUnitsPrm; tpms_NetClstrTyrePressureUnt = insTempUnitsPrm; memset(&tpmsWrnngStatus, 0, sizeof(tpmsWrnngStatus));   tpms_InitSts = TRUE; }   /************************************************** *Function :TPMS_Process_50ms *Description: TPMS Module Process *Parameters:none *Returns: none **create&Verlog: *Author Name xs Date:2017-6-23 Ver:01 ***************************************************/ void TPMS_Process_50ms(void) { if(TRUE == tpms_InitSts) { tpms_SetDistUnitProcess(); tpms_SetFuelConUnitsProcess(); tpms_SetTemUntProcess(); tpms_SetTyrePressureUntProcess();  tpms_Process100MsPRO++; if(TPMS_PROCESS_100MS_CNT >= tpms_Process100MsPRO) { tpms_TireValueProcess_100ms(); tpms_TireStsProcess_100ms(); tpms_Process100MsPRO = 0; } else { /*do nothing*/ }  } else { /*do nothing*/ }   }  /************************************************** *Function :tpms_TireValueProcess_100ms *Description: TPMS Get Tire Value Process *Parameters:none *Returns: none **create&Verlog: *Author Name xs Date:2017-6-23 Ver:01 tpmswndrntrmda ***************************************************/ static void tpms_TireValueProcess_100ms(void) {  BOOL bValue; COM_GetSignalValue_16(INDEX_COM_RS_FLTIREPRS,&tpms_NetFLTirePrs); COM_GetSignalValue_8(INDEX_COM_RS_FLTIREPRSV,&tpms_NetFLTirePrsV);  COM_GetSignalValue_16(INDEX_COM_RS_FRTIREPRS,&tpms_NetFRTirePrs); COM_GetSignalValue_8(INDEX_COM_RS_FRTIREPRSV,&tpms_NetFRTirePrsV); COM_GetSignalValue_16(INDEX_COM_RS_RLTIREPRS,&tpms_NetRLTirePrs); COM_GetSignalValue_8(INDEX_COM_RS_RLTIREPRSV,&tpms_NetRLTirePrsV); COM_GetSignalValue_16(INDEX_COM_RS_RRTIREPRS,&tpms_NetRRTirePrs); COM_GetSignalValue_8(INDEX_COM_RS_RRTIREPRSV,&tpms_NetRRTirePrsV);  COM_GetSignalValue_8(INDEX_COM_RS_FLTIRETEMV, &tpms_NetFLTireTemV); COM_GetSignalValue_16(INDEX_COM_RS_FLTIRETEM, &tpms_NetFLTireTem); COM_GetSignalValue_8(INDEX_COM_RS_FRTIRETEMV, &tpms_NetFRTireTemV); COM_GetSignalValue_16(INDEX_COM_RS_FRTIRETEM, &tpms_NetFRTireTem); COM_GetSignalValue_8(INDEX_COM_RS_RLTIRETEMV, &tpms_NetRLTireTemV); COM_GetSignalValue_16(INDEX_COM_RS_RLTIRETEM, &tpms_NetRLTireTem); COM_GetSignalValue_8(INDEX_COM_RS_RRTIRETEMV, &tpms_NetRRTireTemV); COM_GetSignalValue_16(INDEX_COM_RS_RRTIRETEM, &tpms_NetRRTireTem);  COM_GetSignalValue_8(INDEX_COM_RS_FLTIRESTS,&tpms_NetFLTireSts); COM_GetSignalValue_8(INDEX_COM_RS_FRTIRESTS,&tpms_NetFRTireSts); COM_GetSignalValue_8(INDEX_COM_RS_RLTIRESTS,&tpms_NetRLTireSts); COM_GetSignalValue_8(INDEX_COM_RS_RRTIRESTS,&tpms_NetRRTireSts);  COM_GetSignalValue_BOOL(INDEX_COM_RS_TPMSWNTRMDA, &bValue);  if((VALID == tpms_NetFLTirePrsV) && (FALSE == bValue) && (STATUS_TPMS_TIRE_UNKOWN!= tpms_NetFLTireSts) ) { tpms_NetClstrDspdFLTirePrs = tpms_NetFLTirePrs/4; } else { tpms_NetClstrDspdFLTirePrs = 0; }  if((VALID == tpms_NetFRTirePrsV) && (FALSE == bValue)  && (STATUS_TPMS_TIRE_UNKOWN!= tpms_NetFRTireSts)) { tpms_NetClstrDspdFRTirePrs = tpms_NetFRTirePrs/4; } else { tpms_NetClstrDspdFRTirePrs = 0; }  if((VALID == tpms_NetRLTirePrsV) && (FALSE == bValue)  && (STATUS_TPMS_TIRE_UNKOWN!= tpms_NetRLTireSts) ) { tpms_NetClstrDspdRLTirePrs = tpms_NetRLTirePrs/4; } else { tpms_NetClstrDspdRLTirePrs = 0; }  if((VALID == tpms_NetRRTirePrsV) && (FALSE == bValue)  && (STATUS_TPMS_TIRE_UNKOWN!= tpms_NetRRTireSts)) { tpms_NetClstrDspdRRTirePrs = tpms_NetRRTirePrs/4; } else { tpms_NetClstrDspdRRTirePrs = 0; } }  /************************************************** *Function :tpms_TireStsProcess_100ms *Description: TPMS Get Tire Status Process *Parameters:none *Returns: none **create&Verlog: *Author Name xs Date:2017-6-23 Ver:01 ***************************************************/ static void tpms_TireStsProcess_100ms(void) { BOOL bValue = 0;  COM_GetSignalValue_BOOL(INDEX_COM_RS_TPMSWNTRMDA, &bValue);  if((STATUS_TPMS_TIRE_NORMAL == tpms_NetFLTireSts) &&(VALID == tpms_NetFLTirePrsV) &&(FALSE == bValue)) { tpms_NetClstrDspdFLTireSts = FALSE; } else { tpms_NetClstrDspdFLTireSts = TRUE; }  if((STATUS_TPMS_TIRE_NORMAL == tpms_NetFRTireSts) &&(VALID == tpms_NetFRTirePrsV) &&(FALSE == bValue)) { tpms_NetClstrDspdFRTireSts = FALSE; } else { tpms_NetClstrDspdFRTireSts = TRUE; }  if((STATUS_TPMS_TIRE_NORMAL == tpms_NetRLTireSts) &&(VALID == tpms_NetRLTirePrsV) &&(FALSE == bValue)) { tpms_NetClstrDspdRLTireSts = FALSE; } else { tpms_NetClstrDspdRLTireSts = TRUE; }  if((STATUS_TPMS_TIRE_NORMAL == tpms_NetRRTireSts) &&(VALID == tpms_NetRRTirePrsV) &&(FALSE == bValue)) { tpms_NetClstrDspdRRTireSts = FALSE; } else { tpms_NetClstrDspdRRTireSts = TRUE; }  if((STATUS_TPMS_TIRE_LOW == tpms_NetFLTireSts)  || (STATUS_TPMS_TIRE_LOW == tpms_NetFRTireSts)  || (STATUS_TPMS_TIRE_LOW == tpms_NetRLTireSts)  || (STATUS_TPMS_TIRE_LOW == tpms_NetRRTireSts)) { tpmsWrnngStatus.TPMS_TIRE_LOW = TRUE; } else { tpmsWrnngStatus.TPMS_TIRE_LOW = FALSE; }  if((STATUS_TPMS_TIRE_LEAKAGE == tpms_NetFLTireSts)  || (STATUS_TPMS_TIRE_LEAKAGE == tpms_NetFRTireSts)  || (STATUS_TPMS_TIRE_LEAKAGE == tpms_NetRLTireSts)  || (STATUS_TPMS_TIRE_LEAKAGE == tpms_NetRRTireSts)) { tpmsWrnngStatus.TPMS_TIRE_LEAKAGE = TRUE; } else { tpmsWrnngStatus.TPMS_TIRE_LEAKAGE = FALSE; }  if((STATUS_TPMS_TIRE_HIGH == tpms_NetFLTireSts)  || (STATUS_TPMS_TIRE_HIGH == tpms_NetFRTireSts)  || (STATUS_TPMS_TIRE_HIGH == tpms_NetRLTireSts)  || (STATUS_TPMS_TIRE_HIGH == tpms_NetRRTireSts)) { tpmsWrnngStatus.TPMS_TIRE_HIGH = TRUE; } else { tpmsWrnngStatus.TPMS_TIRE_HIGH = FALSE; }  if((STATUS_TPMS_TEMP_HIGH == tpms_NetFLTireSts)  || (STATUS_TPMS_TEMP_HIGH == tpms_NetFRTireSts)  || (STATUS_TPMS_TEMP_HIGH == tpms_NetRLTireSts)  || (STATUS_TPMS_TEMP_HIGH == tpms_NetRRTireSts)) { tpmsWrnngStatus.TPMS_TEMP_HIGH = TRUE; } else { tpmsWrnngStatus.TPMS_TEMP_HIGH = FALSE; }  if((STATUS_TPMS_BALANCE_FAIL == tpms_NetFLTireSts)  || (STATUS_TPMS_BALANCE_FAIL == tpms_NetFRTireSts)  || (STATUS_TPMS_BALANCE_FAIL == tpms_NetRLTireSts)  || (STATUS_TPMS_BALANCE_FAIL == tpms_NetRRTireSts)) { tpmsWrnngStatus.TPMS_BALANCE_FAIL = TRUE; } else { tpmsWrnngStatus.TPMS_BALANCE_FAIL = FALSE; }  if((STATUS_TPMS_BAT_LOW == tpms_NetFLTireSts)  || (STATUS_TPMS_BAT_LOW == tpms_NetFRTireSts)  || (STATUS_TPMS_BAT_LOW == tpms_NetRLTireSts)  || (STATUS_TPMS_BAT_LOW == tpms_NetRRTireSts)) { tpmsWrnngStatus.TPMS_BAT_LOW = TRUE; } else { tpmsWrnngStatus.TPMS_BAT_LOW = FALSE; } }  /************************************************** *Function :tpms_SetDistUnitProcess *Description: TPMS Set Dist Unit Process *Parameters:none *Returns: none **create&Verlog: *Author Name xs Date:2017-6-23 Ver:01 ***************************************************/ static void tpms_SetDistUnitProcess(void) { COM_GetSignalValue_BOOL(INDEX_COM_RS_FICMDISTUNITADJTREQA, &tpms_NetFICMDistUnitAdjtReqA); if(TRUE == tpms_NetFICMDistUnitAdjtReqA) { COM_GetSignalValue_8(INDEX_COM_RS_FICMDISTUNITADJ, &tpms_NetFICMDistUntAdj); DIAG_SetDistanceUnits(tpms_NetFICMDistUntAdj); tpms_NetClstrDistUnt = tpms_NetFICMDistUntAdj; } else { /*do nothing*/ } }  /************************************************** *Function :tpms_SetFuelConUnitsProcess *Description: TPMS Set FuelCsump Unit Process *Parameters:none *Returns: none **create&Verlog: *Author Name xs Date:2017-6-23 Ver:01 ***************************************************/ static void tpms_SetFuelConUnitsProcess(void) { COM_GetSignalValue_BOOL(INDEX_COM_RS_FICMFUELCSUMPUNTADJRA, &tpms_NetFICMFuelCsumpUntAdjARA); if(FALSE != tpms_NetFICMFuelCsumpUntAdjARA) { COM_GetSignalValue_8(INDEX_COM_RS_FICMFUELCSUMPUNTADJ, &tpms_NetFICMFuelCsumpUntAdj); DIAG_SetFuelConUnits(tpms_NetFICMFuelCsumpUntAdj); tpms_NetClstrFuelCsumpUnt = tpms_NetFICMFuelCsumpUntAdj; } else { /*do nothing*/ } }  /************************************************** *Function :tpms_SetTemUntProcess *Description: TPMS Set Temp Unit Process *Parameters:none *Returns: none **create&Verlog: *Author Name xs Date:2017-6-23 Ver:01 ***************************************************/ static void tpms_SetTemUntProcess(void) { COM_GetSignalValue_BOOL(INDEX_COM_RS_FICMTEMUNTADJTREQA, &tpms_NetFICMTemUntAdjtReqA); if(FALSE != tpms_NetFICMTemUntAdjtReqA) { COM_GetSignalValue_8(INDEX_COM_RS_FICMTEMUNTADJ, &tpms_NetFICMTemUntAdj); DIAG_SetTempUnits(tpms_NetFICMTemUntAdj); tpms_NetClstrTemUnt = tpms_NetFICMTemUntAdj; } else { /*do nothing*/ } }  /************************************************** *Function :tpms_SetTyrePressureUntProcess *Description: TPMS Set TyrePressure Unit Process *Parameters:none *Returns: none **create&Verlog: *Author Name xs Date:2017-6-23 Ver:01 ***************************************************/ static void tpms_SetTyrePressureUntProcess(void) { COM_GetSignalValue_BOOL(INDEX_COM_RS_FICMTYREPRESSUREUNTADJTREQA, &tpms_NetFICMTyrePressureUntAdjtReqA); if(FALSE != tpms_NetFICMTyrePressureUntAdjtReqA) { COM_GetSignalValue_8(INDEX_COM_RS_FICMTYREPRESSUREUNTADJ, &tpms_NetFICMTyrePressureUntAdj); DIAG_SetTyrePresUnits(tpms_NetFICMTyrePressureUntAdj); tpms_NetClstrTyrePressureUnt = tpms_NetFICMTyrePressureUntAdj; } else { /*do nothing*/ } }   /************************************************** *Function :TPMS_SendNetSignal_100ms *Description: TPMS Send Tire Value and Status Signal Process *Parameters:none *Returns: none **create&Verlog: *Author Name xs Date:2017-6-23 Ver:01 ***************************************************/ void TPMS_SendNetSignal_100ms(void) { v_wr_8(ClstrDspdFLTirePrs_handle, tpms_NetClstrDspdFLTirePrs); v_wr_8(ClstrDspdFLTireSts_handle, tpms_NetClstrDspdFLTireSts); v_wr_8(ClstrDspdFRTirePrs_handle, tpms_NetClstrDspdFRTirePrs); v_wr_8(ClstrDspdFRTireSts_handle, tpms_NetClstrDspdFRTireSts); v_wr_8(ClstrDspdRLTirePrs_handle, tpms_NetClstrDspdRLTirePrs); v_wr_8(ClstrDspdRLTireSts_handle, tpms_NetClstrDspdRLTireSts); v_wr_8(ClstrDspdRRTirePrs_handle, tpms_NetClstrDspdRRTirePrs); v_wr_8(ClstrDspdRRTireSts_handle, tpms_NetClstrDspdRRTireSts); }  /************************************************** *Function :TPMS_SendUnitSignal_50ms *Description: TPMS Send Tire Dist temp Fuel Unit Signal Process *Parameters:none *Returns: none **create&Verlog: *Author Name xs Date:2017-6-23 Ver:01 ***************************************************/ void TPMS_SendUnitSignal_50ms(void) { v_wr_8(ClstrDistUnt_handle, tpms_NetClstrDistUnt); v_wr_8(ClstrFuelCsumpUnt_handle, tpms_NetClstrFuelCsumpUnt); v_wr_8(ClstrTemUnt_handle, tpms_NetClstrTemUnt); v_wr_8(ClstrTyrePressureUnt_handle, tpms_NetClstrTyrePressureUnt); }   /************************************************** *Function :TPMS_GetTPMSWarnSts *Description: TPMS interface for Get Tire Warn Type *Parameters:none *Returns: none **create&Verlog: *Author Name xs Date:2017-6-23 Ver:01 ***************************************************/ U8 TPMS_GetTPMSWarnSts(TPMS_WarnType_ST *Sts) { U8 res = RET_FAIL;  if (FALSE == tpms_InitSts) { res = RET_FAIL; } else if (NULL_PTR == Sts) { res = RET_INVALID; } else { *Sts = tpmsWrnngStatus; res = RET_OK; }  return res; }  /************************************************** *Function :TPMS_GetTPMSDATA *Description: Get tpms data *Parameters:output *Returns: RET_OK **create&Verlog: *Author Name xs Date:2017-6-23 Ver:01 ***************************************************/  U8 TPMS_GetTPMSDATA(Dm_TC_TirePress_ST *pData) { BOOL bValue; COM_GetSignalValue_BOOL(INDEX_COM_RS_TPMSWNTRMDA, &bValue);  if(FALSE == bValue) { pData->FLTirePressV = tpms_NetFLTirePrsV; pData->FLTireTempV = tpms_NetFLTireTemV; pData->FRTirePressV = tpms_NetFRTirePrsV; pData->FRTireTempV = tpms_NetFRTireTemV; pData->RLTirePressV = tpms_NetRLTirePrsV; pData->RLTireTempV = tpms_NetRLTireTemV; pData->RRTirePressV = tpms_NetRRTirePrsV; pData->RRTireTempV = tpms_NetRRTireTemV; pData->FLTirePress = tpms_NetFLTirePrs; pData->FLTireTemp = tpms_NetFLTireTem; pData->FRTirePress = tpms_NetFRTirePrs; pData->FRTireTemp = tpms_NetFRTireTem ; pData->RLTirePress = tpms_NetRLTirePrs; pData->RLTireTemp = tpms_NetRLTireTem; pData->RRTirePress = tpms_NetRRTirePrs; pData->RRTireTemp = tpms_NetRRTireTem; pData->FLTireSts = tpms_NetFLTireSts; pData->FRTireSts = tpms_NetFRTireSts; pData->RLTireSts = tpms_NetRLTireSts; pData->RRTireSts = tpms_NetRRTireSts; } else { pData->FLTirePressV = INVALID; pData->FLTireTempV = INVALID; pData->FRTirePressV = INVALID; pData->FRTireTempV = INVALID; pData->RLTirePressV = INVALID; pData->RLTireTempV = INVALID; pData->RRTirePressV = INVALID; pData->RRTireTempV = INVALID; pData->FLTirePress = tpms_NetFLTirePrs; pData->FLTireTemp = tpms_NetFLTireTem; pData->FRTirePress = tpms_NetFRTirePrs; pData->FRTireTemp = tpms_NetFRTireTem ; pData->RLTirePress = tpms_NetRLTirePrs; pData->RLTireTemp = tpms_NetRLTireTem; pData->RRTirePress = tpms_NetRRTirePrs; pData->RRTireTemp = tpms_NetRRTireTem; pData->FLTireSts = tpms_NetFLTireSts; pData->FRTireSts = tpms_NetFRTireSts; pData->RLTireSts = tpms_NetRLTireSts; pData->RRTireSts = tpms_NetRRTireSts;  }  return RET_OK; }  /*=========================================================================================================== tpms.c tpms_cfg.h tpms_info.inc tpms_private.h tpms_public.h File Revision History (bottom to top:first revision to last revision) * *============================================================================================================ *$Log:$ *  *Rev: Userid: date: description *----- ----- ----------- ----------- *Rev 1 xs 2017-06-23 initial ============================================================================================================*/
