  /************************************************************************** | Copyright |------------------------------------------------------------------------ |Copyright(c) by YEEDON MultiMedia Co.LTD. All rights reserved. | | this software if furnished under a license and may be used and copied | only in accordance with the terms of such license and with the inclusion | of he above copyright notic.This software or any other copies thereof | may not be provided of otherwise made available to any other persion. | No title to and ownership of the software is hereby transferred. | | the information in this software is subject to change without notice | and should not be construed as a commitment by | YEEDON MultiMedia Co.LTD. | | YEEDON MultiMedia Co.LTD. assumes no responsibility for the use or reliability | of its Software on equipment which is not supported by YEEDON MultiMedia Co.LTD. |-------------------------------------------------------------- **************************************************************************/    /*-----------------------------------------------------------------------*/ /*----Description of file-----------------------------------------------------*/ /*-----------------------------------------------------------------------*/    /************************************************************************* FTR  *************************************************************************/   /*------------------------------------------------------------------------*/ /*-----Head of file----------------------------------------------------------*/ /*------------------------------------------------------------------------*/ #include "ftr_info.inc"  static BOOL PwrConditon_Flag = FALSE; static BOOL BatConditon_Flag = TRUE; static BOOL WorkConditon_Flag = FALSE;  static U16 PwrConditon_cnt = 0; static U16 BatConditon_cnt = 0; static U16 WorkConditon_cnt = 0;  static U8 ftr_InitSts = 0; static U8 ftr_Dtc_Count;  /************************************************** *Function :FTR_Init *Description: FTR_Init Module Inital *Parameters:none *Returns: none **create&Verlog: *Author Name csm Date:2017-07-04 Ver:2.0 ***************************************************/ void FTR_Init(void) {  PwrConditon_Flag = 0; BatConditon_Flag = 0; WorkConditon_Flag = 0;  PwrConditon_cnt = 0; BatConditon_cnt = 0; WorkConditon_cnt = 0; ftr_Dtc_Count =0;  ftr_InitSts = BAT_GetInitSts();  }    /************************************************** *Function :FTR_Process_50ms *Description: ftr Module process *Parameters:none *Returns: none **create&Verlog: *Author Name csm Date:2017-07-04 Ver:2.0 ***************************************************/ void FTR_Process_50ms(void) { ftr_pwr_condition_detect(); ftr_work_condition_detect(); ftr_bat_condition_detect(); ftr_dtc_report();  } /************************************************** *Function :ftr_pwr_condition_detect *Description: ftr Module process *Parameters:none *Returns: none **create&Verlog: *Author Name csm Date:2017-07-04 Ver:2.0 ***************************************************/ static void ftr_pwr_condition_detect(void) { U8 Mode = 0; U8 batSts = 0;  PWR_GetPwrMode(&Mode); switch (Mode)  {  case PWR_CRANK: PwrConditon_cnt =0; PwrConditon_Flag = FALSE; break; case PWR_OFF: case PWR_ACC:  case PWR_RUN: if (PWRCONDITION_CNT <= PwrConditon_cnt) { PwrConditon_Flag = TRUE;  } else { PwrConditon_cnt ++; }   break; }  return; }   /************************************************** *Function :ftr_bat_condition_detect *Description: ftr Module process *Parameters:none *Returns: none **create&Verlog: *Author Name csm Date:2017-07-04 Ver:2.0 ***************************************************/ static void ftr_bat_condition_detect(void) { U8 sts = 0;  BAT_GetBatFltSts(TYPE_BATDET_TD,&sts); if(FLT_BAT_NO == sts) { BatConditon_cnt++; if(BATCONDITION_CNT <= BatConditon_cnt) { BatConditon_Flag = TRUE; } else { } } else { BatConditon_Flag = FALSE; BatConditon_cnt = 0; }  return;  }   /************************************************** *Function :ftr_work_condition_detect *Description: ftr Module process *Parameters:none *Returns: none **create&Verlog: *Author Name csm Date:2017-07-04 Ver:2.0 ***************************************************/ static void ftr_work_condition_detect(void) { if(WORKCONDITION_CNT <= WorkConditon_cnt) { WorkConditon_Flag = TRUE; } else { WorkConditon_cnt ++; WorkConditon_Flag = FALSE; } }  /************************************************** *Function :ftr_dtc_report *Description: ftr fault report *Parameters:none *Returns: none **create&Verlog: *Author Name csm Date:2017-07-04 Ver:2.0 ***************************************************/ static void ftr_dtc_report(void) { U8 sts = 0; U8 batSts = 0;  SSBFlt_ST ssbSts; TIPFlt_ST TipSts; /*----BAT DTC REPROT-----START------------*/ if ((TRUE == PwrConditon_Flag)  && (TRUE == WorkConditon_Flag)) { BAT_GetBatFltSts(TYPE_BATDET_TD,&batSts); if (FLT_BAT_NO == batSts)  {   f_fm_setDTCByNo(DTC_D56217,FALSE); f_fm_setDTCByNo(DTC_D56316,FALSE); }  else {  if (FLT_BAT_VOL_HIGH ==batSts)  { f_fm_setDTCByNo(DTC_D56217,TRUE); } else { f_fm_setDTCByNo(DTC_D56316,TRUE); }  } } else { } /*----BAT DTC REPROT-----END------------*/   /*----OTHER DTC REPROT-----START--------*/ if ((TRUE == PwrConditon_Flag)  && (TRUE == BatConditon_Flag) && (TRUE == WorkConditon_Flag))  { ftr_Dtc_Count++; switch (ftr_Dtc_Count)  { case SUB_DTC_FLOW1: NWD_GetNodeMissing(INDEX_ECM_NODE,&sts); f_fm_setDTCByNo(DTC_C10087,sts);  NWD_GetNodeMissing(INDEX_BCM_NODE,&sts); f_fm_setDTCByNo(DTC_C14087,sts);   NWD_GetNodeMissing(INDEX_TCM_NODE,&sts); f_fm_setDTCByNo(DTC_C10187,sts);   NWD_GetNodeMissing(INDEX_SDM_NODE,&sts); f_fm_setDTCByNo(DTC_C15187,sts);   NWD_GetNodeMissing(INDEX_FICM_NODE,&sts); f_fm_setDTCByNo(DTC_C24587,sts);  break;  case SUB_DTC_FLOW2:  f_fm_setDTCByNo(DTC_922186,ODO_GetOdoInvalidFlt());  f_fm_setDTCByNo(DTC_922000,ODO_GetOdoIncreaseFlt()); SSB_GetSSBFltSts(&ssbSts); f_fm_setDTCByNo(DTC_975371,ssbSts.Stuck);   f_fm_setDTCByNo(DTC_976400,ssbSts.MisMatch);  CRUS_GetFltStatus(&sts); switch(sts) { case FAULT_CRUS1_BAT: f_fm_setDTCByNo(DTC_056412,TRUE); break;  case FAULT_CRUS1_GND: f_fm_setDTCByNo(DTC_056411,TRUE); break;  case FAULT_CRUS1_OUTRANGE: f_fm_setDTCByNo(DTC_05641C,TRUE);  break;  case FAULT_CRUS1_STICKY: f_fm_setDTCByNo(DTC_056496,TRUE);  break; }  break;  case SUB_DTC_FLOW3:  TIP_GetFltStatus(&TipSts); f_fm_setDTCByNo(DTC_095596,TipSts.Stuck);  f_fm_setDTCByNo(DTC_09551C,TipSts.OutRang); if(TRUE == FL_GetFuelSensorFaultFlag()) { f_fm_setDTCByNo(DTC_920029,TRUE);  } else { f_fm_setDTCByNo(DTC_920029,FALSE);  } SLF_GetSrsLedFltStatus(&sts); f_fm_setDTCByNo(DTC_920100,sts); break;  case SUB_DTC_FLOW0: default:  EED_GetEEPROMStatus(&sts);  switch(sts) { case STATUS_EED_READING: case STATUS_EED_WRITEING: case STATUS_EED_PROTECTING: break;  case STATUS_EED_UNKNOWN: case STATUS_EED_ERR: f_fm_setDTCByNo(DTC_E00142,TRUE);  break;  case STATUS_EED_IDLE: default: break;  }  f_fm_setDTCByNo(DTC_C07388,NWD_GetBusOffFlt()); ftr_Dtc_Count =0; break; } } else { }  /*----OTHER DTC REPROT-----END--------*/ }  /*=========================================================================================================== ftr.c ftr_cfg.h ftr_info.inc ftr_private.h ftr_public.h File Revision History (bottom to top:first revision to last revision) * *============================================================================================================ *$Log:$ *  *Rev: Userid: date: description *----- ----- ----------- ----------- *Rev 1 csm 2017-0704 initial ============================================================================================================*/
