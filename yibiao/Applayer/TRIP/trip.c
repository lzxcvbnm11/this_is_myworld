/***************************************************************************** trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Copyright (C) 2016 ShenZhen Yeedon Media co.,LTD. All rights reserved. * trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h File Name : trip.c trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Description : TRIP module applayer trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Author: Xiaojie.Zheng trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Date: 2016-12-02 ******************************************************************************/  /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr Files for including */ #include "trip_info.inc"  static BOOL trip_InitSts = FALSE; /*TRIP模块的初始化状态*/ static BOOL trip_RstFlag1 = FALSE; /*TRIP1复位标志*/ static BOOL trip_RstFlag2 = FALSE; /*TRIP2复位标志*/ static BOOL trip_KeyPressFlag = FALSE; /*TRIP行车电脑按键是否有按键按下的标志*/ static U16 trip_ADCValue = 0; /*当前的AD值*/ static U16 trip_ADCValueTemp = 0; /*保存前一次的AD值*/ static U32 trip_CntLongPress = 0; /*按键长按计数*/ static U32 trip_TimeCnt1 = 0; /*规定按键长按次数*/ static U8 trip_Trip1RstTime = 0; /*trip1复位时间*/ static U32 trip_CRstCounter = 0; /*清除复位计数*/ static BOOL trip_ClearRstFlag = FALSE; /*判断是否清除TRIP1复位标志*/ static TRIPKeySts_ST trip_KeyStatus; /*按键状态结构体变量*/ static U32 tickStart = 0; /*存储trip1复位判断的开始时间*/ static U32 tickEnd = 0; /*存储trip1复位判断的结束时间*/ static U8 insPresstime1Prm; /*按键长按时间*/ static U8 insTripResetTimeoutPrm; /*trip1复位时间*/ static BOOL insTrip1UserEnPrm;  static RtcaTime_ST trip_start_sysTime; static RtcaTime_ST trip_end_sysTime;  /*************************************************** trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Function: TRIP_Init trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Description: TRIP drive computer button initialization trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Parameters: none trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Returns: none trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h $Create & Verlog:$ trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Author: Xiaojie.Zheng Date:2016-12-02 Version:V1.0 trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Author: huangyifan Date:2017-06-28 Version:V2.0 *$ log :use diag_getxx *$log:insTripResetTimeoutPrm plus 10;due to part4 ****************************************************/ void TRIP_Init(void) { U8 res = RET_FAIL;  trip_CntLongPress = 0; trip_ADCValue = 0; trip_ADCValueTemp = 0; trip_CRstCounter = 0; trip_InitSts = FALSE; trip_RstFlag1 = FALSE; trip_RstFlag2 = FALSE; trip_KeyPressFlag = FALSE; trip_ClearRstFlag = FALSE; trip_KeyStatus.type = TYPE_TRIP_NULL; trip_KeyStatus.status = STATUS_TRIP_PRESS_NO; tickStart = 0; tickEnd = 0; insPresstime1Prm = DIAG_GetPresstime1(); insTripResetTimeoutPrm = DIAG_GetTripResetTimeout(); insTrip1UserEnPrm = DIAG_GetTrip1UserEn();  trip_TimeCnt1 = S_TO_MS(insPresstime1Prm*0.25) / TRIP_PERIOD; trip_Trip1RstTime = insTripResetTimeoutPrm trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h 10 ; trip_InitSts = ADM_GetInitStatus();  NZM_GetDataValue(INDEX_NZM_SYSTIME,&trip_start_sysTime,10); if(trip_start_sysTime.year == 0)  { RTCA_GetTime(&trip_start_sysTime); RTCA_GetTime(&trip_end_sysTime); } }  /*************************************************** trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Function: TRIP_Process_20ms trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Description: trip module processing function trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Parameters: none trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Returns: none trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h $Create & Verlog:$ trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Author: Xiaojie.Zheng Date:2016-12-02 Version:V1.0 ****************************************************/ void TRIP_Process_20ms(void) { U8 res = RET_FAIL; U8 resRtc = RET_FAIL; U8 resRst = RET_FAIL; U8 resOStm = RET_FAIL; U8 rsttype = TYPE_RST_EXTERNAL;  U8 pwrMode = PWR_OFF;  PTime_ST curRtcTime; static U8 trip_PwrMode = PWR_OFF; Dm_CMD_ST fun;  U64 value1 = 0; U64 value2 = 0; U8 i = 0; U16 day = 0;  if (TRUE== trip_InitSts) { res = PWR_GetPwrMode(&pwrMode); resRst = RST_GetRstSource(&rsttype); DM_UpdatePageInfo(&fun); if (RET_OK == res) { if((PWR_OFF == pwrMode) ||(PWR_ACC == pwrMode)) { if((PWR_CRANK == trip_PwrMode) ||(PWR_RUN== trip_PwrMode)) { //tickStart = R_TICK_GetTimeMS(0); #if 1//liuyingying @20171221 rtc RTCA_GetTime(&trip_start_sysTime); #endif } else { } #if 1//liuyingying @20171221 rtc RTCA_GetTime(&trip_end_sysTime); #endif  #if 1//liuyingying @20171221 rtc value1 = trip_end_sysTime.year *365*24*60*60; for(i = 1; i <trip_end_sysTime.month; i ++) { day +=monthDayTab[i]; if((2 == i) && (0 == trip_end_sysTime.year%4)) day +=1; } value1 +=(day+trip_end_sysTime.day)*24*60*60; value1 +=(trip_end_sysTime.hour*60*60); value1 +=(trip_end_sysTime.minute*60); value1 +=(trip_end_sysTime.sec);  value2 = trip_start_sysTime.year *365*24*60*60; for(i = 1; i <trip_start_sysTime.month; i ++) { day +=monthDayTab[i]; if((2 == i) && (0 == trip_start_sysTime.year%4)) day +=1; } value2 +=(day+trip_start_sysTime.day)*24*60*60; value2 +=(trip_start_sysTime.hour*60*60); value2 +=(trip_start_sysTime.minute*60); value2 +=(trip_start_sysTime.sec);  if(value1 > value2) { if((value1 - value2) >(trip_Trip1RstTime*60)) { trip_RstFlag1 = TRUE; } else { } } else { }  #else if((PWR_CRANK == trip_PwrMode) ||(PWR_RUN== trip_PwrMode)) { tickStart = R_TICK_GetTimeMS(0); } else { } tickEnd = R_TICK_GetTimeMS(0); if (trip_Trip1RstTime <= ((tickEnd - tickStart)/60000))/*300000*/ { trip_RstFlag1 = TRUE; trip_ClearRstFlag = FALSE; } else { trip_ClearRstFlag = FALSE; } #endif     } else { } trip_PwrMode = pwrMode; } else { }  trip_GetKeySts();/*key detect*/ if ((TYPE_TRIP_OK == trip_KeyStatus.type) && (STATUS_TRIP_PRESS_LONG == trip_KeyStatus.status)) { if((INDEX_FUNCTION == fun.PageType) && (MAINFUCTION_TC == fun.MainPage) && (SUBFUCTION_TC_AUTOSTART == fun.SubPage)) { trip_RstFlag1 = TRUE; } else if((INDEX_FUNCTION == fun.PageType) && (MAINFUCTION_TC == fun.MainPage) && (SUBFUCTION_TC_AUTORST== fun.SubPage)) { trip_RstFlag2 = TRUE; } else { } } else { if (TRUE == resRst) { if (TYPE_RST_POC0RES == rsttype) { trip_RstFlag1 = TRUE; trip_RstFlag2 = TRUE; } else { } } else { } }  if ((TRUE == trip_RstFlag1) || (TRUE == trip_RstFlag2)) /*reset condition satisfy*/ { trip_CRstCounter++; if (TRIP_CRSTCNT <= trip_CRstCounter) { trip_RstFlag1 = FALSE; trip_RstFlag2 = FALSE; trip_CRstCounter = 0; } else { } } else { } } else { } }  /*************************************************** trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Function: TRIP_GetTripRstSts trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Description: gets the reset state of the trip drive computer trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Parameters: tripIndex : the reset type of the TRIP driving computer keys tripRstFlag : store the rstflag trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Returns: RET_FAIL RET_INVALID RET_OK trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h $Create & Verlog:$ trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Author: Xiaojie.Zheng Date:2016-12-02 Version:V1.0 ****************************************************/ U8 TRIP_GetTripRstSts(TRIPRstType_ENUM tripIndex, PU8 tripRstFlag) { U8 trip_res = RET_FAIL;  if (FALSE == trip_InitSts) { trip_res = RET_FAIL; } else { if ((RSTTYPE_TRIP_ALL == tripIndex) || (RSTTYPE_TRIP_PRESS_NO == tripIndex) || (NULL_PTR == tripRstFlag)) { trip_res = RET_INVALID; } else if (RSTTYPE_TRIP_TRIP1 == tripIndex) { *tripRstFlag = trip_RstFlag1; trip_res = RET_OK; } else { *tripRstFlag = trip_RstFlag2; trip_res = RET_OK; } } return trip_res; }  /*************************************************** trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Function: TRIP_GetKeyEvent trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Description: Returns the type and status of the key trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Parameters: TRIPKeySts_ST:structure for defining TRIP driving computer key state trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Returns: RET_FAIL RET_INVALID RET_OK trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h $Create & Verlog:$ trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Author: Xiaojie.Zheng Date:2016-12-02 Version:V1.0 ****************************************************/ U8 TRIP_GetGetKeyEvent(TRIPKeySts_ST *PValue) { U8 trip_res = RET_OK;  if (FALSE == trip_InitSts) { trip_res = RET_FAIL; } else if (NULL_PTR == PValue) { trip_res = RET_INVALID; } else { PValue->status = trip_KeyStatus.status; PValue->type = trip_KeyStatus.type;  trip_KeyStatus.status =STATUS_TRIP_PRESS_NO; }  return trip_res; }    /*************************************************** trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Function: TRIP_GetRTCTime trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Description: Returns the type and status of the key trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Parameters: TRIPKeySts_ST:structure for defining TRIP driving computer key state trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Returns: RET_FAIL RET_INVALID RET_OK trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h $Create & Verlog:$ trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Author: Xiaojie.Zheng Date:2016-12-02 Version:V1.0 ****************************************************/ U8 TRIP_GetRTCTime(RtcaTime_ST *PValue) { U8 trip_res = RET_OK;  if (FALSE == trip_InitSts) { trip_res = RET_FAIL; } else if (NULL_PTR == PValue) { trip_res = RET_INVALID; } else { *PValue = trip_start_sysTime; }  return trip_res; }  /*************************************************** trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Function: trip_GetKeySts trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Description: Get key state trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Parameters: input: none trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Returns: none trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h $Create & Verlog:$ trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Author: Xiaojie.Zheng Date:2016-12-02 Version:V1.0 ****************************************************/ static void trip_GetKeySts(void) { if (TRUE == ADM_GetDebounceValue(INDEX_ADM_TRIPCOMPUTER, &trip_ADCValue)) { if ((ABS_SUB(trip_ADCValue, TRIP_REOPEN)) < (TRIP_OFFSET)) { trip_CntLongPress =0; if (TRUE ==trip_KeyPressFlag) { trip_KeyPressFlag = FALSE; trip_KeyStatus.status = STATUS_TRIP_PRESS_SHORT; } else { } } else { if ((ABS_SUB(trip_ADCValue, TRIP_OK)) < (TRIP_OFFSET)) { trip_KeyStatus.type = TYPE_TRIP_OK; } else if ((ABS_SUB(trip_ADCValue, TRIP_UP)) < (TRIP_OFFSET)) { trip_KeyStatus.type = TYPE_TRIP_UP; } else if ((ABS_SUB(trip_ADCValue, TRIP_DOWN)) < (TRIP_OFFSET)) { trip_KeyStatus.type = TYPE_TRIP_DOWN; } else if ((ABS_SUB(trip_ADCValue, TRIP_LEFT)) < (TRIP_OFFSET)) { trip_KeyStatus.type = TYPE_TRIP_LEFT; } else if ((ABS_SUB(trip_ADCValue, TRIP_RIGHT)) < (TRIP_OFFSET)) { trip_KeyStatus.type = TYPE_TRIP_RIGHT; } else { trip_KeyStatus.type = TYPE_TRIP_NULL; }  if(trip_KeyStatus.type != TYPE_TRIP_NULL) { trip_CntLongPress++; if (trip_CntLongPress > trip_TimeCnt1) { if (TRUE ==trip_KeyPressFlag)  { trip_KeyPressFlag = FALSE; trip_KeyStatus.status = STATUS_TRIP_PRESS_LONG; } else { } } else { if (FALSE ==trip_KeyPressFlag)  { trip_KeyPressFlag = TRUE; trip_CntLongPress = 0; } else { } } } else { if (TRUE ==trip_KeyPressFlag) { trip_KeyPressFlag = FALSE; trip_KeyStatus.status = STATUS_TRIP_PRESS_OUTRANGE; } else { } } }  } else { } }  /*=========================================================================== trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h File Revision History(bottom to top:first revision to last revision) *============================================================================ trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h $Log:$ * trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h Rev: Userid: Date: Description *-------- ---------- --------- ------------------------------ * trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h V1.0 Xiaojie.Zheng 2016-12-02 Initial trip.c trip_cfg.h trip_info.inc trip_private.h trip_public.h V2.0 huangyifan 2017-06-28 modify *===========================================================================*/
