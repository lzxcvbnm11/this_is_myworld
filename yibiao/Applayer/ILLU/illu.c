/***************************************************************************** illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Copyright (C) 2016 ShenZhen Yeedon Media co.,LTD. All rights reserved. * illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h File Name : illu.c illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Description : illu module middleware illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Author: Xueping.Chen illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Date: 2016-12-05 ******************************************************************************/ #include "illu_info.inc"   /*************************************************** illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Function: ILLU_Init illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Description: the initializing of the illu module illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Parameters: none illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Returns: none illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h $Create & Verlog:$ illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Author:Xueping.Chen Date:2016-12-05 Version:V1.0 ****************************************************/ void ILLU_Init(void) { U8 i = 0;  insStandbyTPrm = DIAG_GetStandbyT();  insTachoSpeedoIllCharPrm.data= DIAG_GetTachoSpeedoIllChar(); insTachoSpeedoPointerIllCharPrm.data= DIAG_GetTachoSpeedoPointerIllChar(); insSegLCDWhiteIllCharPrm.data= DIAG_GetSegLCDWhiteIllChar(); insWarnIllCharPrm.data= DIAG_GetWarnIllChar(); insTachoSpeedoWhiteIllAFactorPrm = DIAG_GetTachoSpeedoWhiteIllAFactor(); insMenuIllumAdEnPrm = DIAG_GetMenuIllumAdEn();  IsUIControlEn = FALSE; NodeMissingEn = FALSE;  illu_IsDay = TRUE;  illu_Event.isBeamLight = 0; illu_Event.isKeyForgot= 0; illu_Event.isSideLight= 0; illu_Event.isDone = 0; illu_Event.isDoorFirstOpen= 1; illu_Event.isWelcome = 0;  Illu_CHANNEL_EN[CHANNEL_ILLU_TFT] = FALSE; Illu_CHANNEL_EN[CHANNEL_ILLU_PANEL] = FALSE; Illu_CHANNEL_EN[CHANNEL_ILLU_POINTER] = FALSE;  illu_PWR_EN = FALSE;  illu_CntValue = (U16) (S_TO_MS(insStandbyTPrm) / ILLU_PROCESS_PERIOD); /*将时间转换为计数*/ illu_GCounter = illu_CntValue;  for (i = 0; i < CHANNEL_ILLU_INDICATOR; i++) { illu_BackLight_Duty[i] = FALSE; }  illu_BackLight_Duty[CHANNEL_ILLU_INDICATOR] = (U8)(insTachoSpeedoWhiteIllAFactorPrm illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h ILLU_ST_BACKLIGHT_DEFAULT); illu_InitSts = ((IOM_GetModuleStatus()) && (PWMM_GetInitStatus())); }  /*************************************************** illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Function: ILLU_Process_100ms illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Description: the process of the illu module illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Parameters: none illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Returns: none illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h $Create & Verlog:$ illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Author:Xueping.Chen Date:2016-12-05 Version:V1.0 ****************************************************/ void ILLU_Process_100ms(void) { U8 res = RET_FAIL; U8 pwrMode = 0;  U8 batsts; U8 selfChk = 0;  U8 stsvalue = 0; U8 BrighressValue;  IlluPWMCh_ENUM index; IlluPWMCh_ENUM i = CHANNEL_ILLU_TFT;  if (TRUE == illu_InitSts) { res = BAT_GetBatFltSts(TYPE_BATDET_TD,&batsts); if (res == RET_OK)  { switch (batsts) { case FLT_BAT_VOL_HIGH: case FLT_BAT_VOL_LOW:  break;  case FLT_BAT_NO: default: res = PWR_GetPwrMode(&pwrMode); if (RET_OK == res) { COM_GetSignalValue_8(INDEX_COM_RS_VEHSIDELGHTSTS, &stsvalue); if (stsvalue == LIGHTOFF_ALL) { illu_IsDay = TRUE; } else { illu_IsDay = FALSE; }   switch (pwrMode) { case PWR_OFF: case PWR_ACC: illu_PwrNotKL15_Process(); break; default: illu_Event.isDoorFirstOpen= 0; illu_Event.isWelcome = 0;  illu_NormalProcess(); break; }  Illu_CHANNEL_EN[CHANNEL_ILLU_INDICATOR] =TRUE;  illu_CalIlluBackLightDuty();  res = PWR_GetChkStatus(&selfChk); switch(selfChk) { case STATUS_SLFCHK_ING: illu_BackLight_Duty[CHANNEL_ILLU_INDICATOR]  =(U8)(0.4 illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h insWarnIllCharPrm.prm.BYTE[0]); break;  case STATUS_SLFCHK_NOT_READY:  case STATUS_SLFCHK_FINISH: default: break; } } else { }  if (FALSE ==illu_PWR_EN) { illu_PWR_EN =TRUE; } else { } break; }  if((TRUE == COM_GetNetWorkSleepSts()) || (FLT_BAT_VOL_HIGH == batsts) || (FLT_BAT_VOL_LOW == batsts)) { illu_PWR_EN = FALSE; for (i =CHANNEL_ILLU_TFT; i < CHANNEL_ILLU_ALL; i++) {  Illu_CHANNEL_EN[i] = FALSE; illu_BackLight_Duty[i] = 0; } } else { }  if (TRUE == illu_PWR_EN) { IOM_SetOutPutLevel(INDEX_IOOUTPUT_LEDENABLE, STATUS_IOM_HIGH); } else { IOM_SetOutPutLevel(INDEX_IOOUTPUT_LEDENABLE, STATUS_IOM_LOW);  }  for (i =CHANNEL_ILLU_TFT; i < CHANNEL_ILLU_ALL; i++) { PWMM_SetOutPutEnable(i, Illu_CHANNEL_EN[i]); PWMM_SetValue(i,illu_BackLight_Duty[i]); } }  else { /*do nothing*/ } } else { /*do nothing*/ } }  /*************************************************** illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Function: illu_PwrNotKL15_Process illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Description: the process of the illu module in PwrNotKL15 illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Parameters: none illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Returns: none illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h $Create & Verlog:$ illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Author:Xueping.Chen Date:2016-12-05 Version:V1.0 ****************************************************/ static void illu_PwrNotKL15_Process(void) { U8 res = RET_FAIL; U8 pwrMode = 0;  U8 NetDoorOpenSts = 0;  static U8 Illu_tftDlayCnt =0;  MSG_EVENT_ENUM Cur_MsgEvt;  res = PWR_GetPwrMode(&pwrMode); if (RET_OK == res) {  COM_GetSignalValue_8(INDEX_COM_RS_DRVRDOOROPENSTS, &NetDoorOpenSts);  Illu_CHANNEL_EN[CHANNEL_ILLU_TFT] = FALSE; Illu_CHANNEL_EN[CHANNEL_ILLU_PANEL] = FALSE; Illu_CHANNEL_EN[CHANNEL_ILLU_POINTER] = FALSE;  /*EVENT JUDGE - WELCOME*/ if (PWR_OFF ==pwrMode &&FALSE != NetDoorOpenSts &&illu_Event.isDoorFirstOpen) { illu_Event.isDoorFirstOpen =0; illu_Event.isWelcome =1; illu_GCounter =0;  #if 0 if((TRUE == insMenuIllumAdEnPrm) && (FALSE ==illu_IsDay)) { IsUIControlEn = TRUE; } else { IsUIControlEn = FALSE; }  #endif   } else { /*do nothing*/ }   if((TRUE == insMenuIllumAdEnPrm) && (FALSE ==illu_IsDay)) { IsUIControlEn = TRUE; } else { IsUIControlEn = FALSE; }    if (illu_GCounter < illu_CntValue) { illu_GCounter ++;  if (FALSE != NetDoorOpenSts) { Illu_tftDlayCnt =2; //Illu_CHANNEL_EN[CHANNEL_ILLU_TFT] = TRUE; } else { illu_Event.isWelcome =0; }  Illu_CHANNEL_EN[CHANNEL_ILLU_PANEL] = TRUE; Illu_CHANNEL_EN[CHANNEL_ILLU_POINTER] = TRUE; } else { illu_Event.isWelcome =0; }  if (Illu_tftDlayCnt >0)  { Illu_tftDlayCnt--; Illu_CHANNEL_EN[CHANNEL_ILLU_TFT] = TRUE; } else { }   res = MSG_GetPopIndex(&Cur_MsgEvt);  if (INDEX_MSG_NULL !=Cur_MsgEvt) { Illu_CHANNEL_EN[CHANNEL_ILLU_TFT] =TRUE; } else { NetDoorOpenSts =0; }  } }  /*************************************************** illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Function: illu_NormalProcess illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Description: the normal process of setting the illu illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Parameters: none illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Returns: none illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h $Create & Verlog:$ illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Author:Xueping.Chen Date:2016-12-05 Version:V1.0 ****************************************************/ static void illu_NormalProcess(void) { U8 sts = 0;  NWD_GetNodeMissing(INDEX_BCM_NODE, &sts);  Illu_CHANNEL_EN[CHANNEL_ILLU_TFT] = TRUE; Illu_CHANNEL_EN[CHANNEL_ILLU_PANEL] = TRUE; Illu_CHANNEL_EN[CHANNEL_ILLU_POINTER] = TRUE;  if(TRUE == sts) { NodeMissingEn = TRUE; } else { NodeMissingEn = FALSE; }   if((TRUE == insMenuIllumAdEnPrm) && (FALSE ==illu_IsDay)) { IsUIControlEn = TRUE; } else { IsUIControlEn = FALSE; }  return; }  /*************************************************** illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Function: illu_CalIlluBackLightDuty illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Description: calculate duty  illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Returns: TRUE or FALSE illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h $Create & Verlog:$ illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Author:liuyingying Date:2017-10-17 Version:V2.0 ****************************************************/ static void illu_CalIlluBackLightDuty(void) {  U8 BrighressValue; U8 i = 0; float Factor = 0.4;  for(i = CHANNEL_ILLU_TFT; i < CHANNEL_ILLU_ALL; i ++) { if(CHANNEL_ILLU_PANEL== i) { Factor = (insTachoSpeedoWhiteIllAFactorPrm*TACHO_WHITE_FACTOR); } else { Factor = TACHO_WHITE_FACTOR *100; }  if(FALSE == NodeMissingEn) { if(TRUE == illu_IsDay) { illu_BackLight_Duty[i] =(U8)(Factor illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h illu_pLightTab[i]->BYTE[0]); } else { if(TRUE == IsUIControlEn) { switch(CurUILevel) { case BRIGHTNESS_ILLU_NIGLEVEL1: illu_BackLight_Duty[i] =(U8)(Factor illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h illu_pLightTab[i]->BYTE[3]); break;  case BRIGHTNESS_ILLU_NIGLEVEL2: illu_BackLight_Duty[i] =(U8)(Factor illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h illu_pLightTab[i]->BYTE[2]); break;  case BRIGHTNESS_ILLU_NIGLEVEL3: illu_BackLight_Duty[i] =(U8)(Factor illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h illu_pLightTab[i]->BYTE[1]); break;  case BRIGHTNESS_ILLU_DAYLEVEL: default : break; } } else { illu_BackLight_Duty[i] =(U8)(Factor illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h illu_pLightTab[i]->BYTE[2]); } } } else/*Node Missing*/ { illu_BackLight_Duty[i] =(U8)((Factor illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h  illu_pLightTab[i]->BYTE[1])/** ILLU_ST_BACKLIGHT_DEFAULT*/) ; } }  for(i = CHANNEL_ILLU_TFT; i < CHANNEL_ILLU_ALL; i ++) { if(ILLU_DUTY_MAX < illu_BackLight_Duty[i]) { illu_BackLight_Duty[i] = ILLU_DUTY_MAX; } else { } } }  /*************************************************** illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Function: ILLU_SetILLULevel illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Description: set the level of the illu illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Parameters: channel : input the channel of the illu pwm level : input the level of the illu illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Returns: TRUE or FALSE illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h $Create & Verlog:$ illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Author:Xueping.Chen Date:2016-12-05 Version:V1.0 ****************************************************/ U8 ILLU_SetILLULevel(IlluPWMCh_ENUM channel, IlluLevel_ENUM Level) {  if (FALSE == illu_InitSts) { return RET_FAIL; }  else if ((channel >= CHANNEL_ILLU_ALL) || (Level >= BRIGHTNESS_ILLU_ALL)) { return RET_INVALID; } else { CurUILevel = Level; return RET_OK; } }  U8 ILLU_GetILLULevel(PU8 pLevel) {  if(FALSE == illu_InitSts) {  return RET_FAIL; }  else if(NULL_PTR == pLevel) {  return RET_INVALID; }  *pLevel = CurUILevel; return RET_OK; } /*************************************************** illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Function: ILLU_GetWelComeSts illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Description: get door open status illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Parameters: void illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Returns: TRUE or FALSE illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h $Create & Verlog:$ illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Author:Xueping.Chen Date:2016-12-05 Version:V1.0 ****************************************************/ BOOL ILLU_GetWelComeSts(void) { return illu_Event.isWelcome; }  BOOL ILLU_GetMenuEnable(void) { return IsUIControlEn; }  BOOL ILLU_GetLcdOnSts(void) { return Illu_CHANNEL_EN[CHANNEL_ILLU_TFT]; } /*=========================================================================== illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h File Revision History(bottom to top:first revision to last revision) *============================================================================ illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h $Log:$ * illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h Rev: Userid: Date: Description *-------- ---------- --------- ------------------------------ * illu.c illu_cfg.h illu_info.inc illu_private.h illu_public.h V1.0 Xueping.Chen 2016-12-05 Initial * *===========================================================================*/
