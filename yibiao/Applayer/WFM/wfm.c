 /************************************************************************** | Copyright |------------------------------------------------------------------------ |Copyright(c) by YEEDON MultiMedia Co.LTD. All rights reserved. | | this software if furnished under a license and may be used and copied | only in accordance with the terms of such license and with the inclusion | of he above copyright notic.This software or any other copies thereof | may not be provided of otherwise made available to any other persion. | No title to and ownership of the software is hereby transferred. | | the information in this software is subject to change without notice | and should not be construed as a commitment by | YEEDON MultiMedia Co.LTD. | | YEEDON MultiMedia Co.LTD. assumes no responsibility for the use or reliability | of its Software on equipment which is not supported by YEEDON MultiMedia Co.LTD. |-------------------------------------------------------------- **************************************************************************/    /*-----------------------------------------------------------------------*/ /*----Description of file-----------------------------------------------------*/ /*-----------------------------------------------------------------------*/    /************************************************************************* LED source file used for LED ON,OFF,FLASH control when warn or other event trigged *************************************************************************/   /*------------------------------------------------------------------------*/ /*-----Head of file----------------------------------------------------------*/ /*------------------------------------------------------------------------*/ #include "wfm_info.inc"  /*==========variables=================*/ static U8 ClstrDspdFuelSts = 0; static U8 wfm_WTFault = 0; static U8 wfm_fuelSeg = 0; static U8 wfm_TmptSeg = 0; static U8 wfm_InvalidFltTmptSeg = 0; static U8 wfm_ecmNodeMiss = FALSE; static U8 wfm_coolantInvalidFlt = FALSE; static DBL wfm_DisplayFuel = 0; static S16 wfm_NetEnClntTem = 0; static U8 wfm_NetEnClntTemV = 0; static U8 wfm_FuelFault = 0; static U8 wfm_NetClstrDspdFuelLvlSgmt = 0; static U8 wfm_NetClstrDspdClntTemWrnng = 0; static U16 wfm_NetFuelTotCapct = 0; static U8 wfm_InitSts = FALSE; static U8 wfm_WrnngProssPRO = 0; static U8 wfm_fuelsnsflt = 0; static IgnCYCLE_ENUM wfm_Cycle = STATE_CYCLE_NORMAL; static U16 insFuelSeg1ThresPrm; static U16 insFuelSeg2ThresPrm; static U16 insFuelSeg3ThresPrm; static U16 insFuelSeg4ThresPrm; static U16 insFuelSeg5ThresPrm; static U16 insFuelSeg6ThresPrm; static U16 insFuelSeg7ThresPrm; static U16 insFuelSeg8ThresPrm; static S16 insTempSeg2ThresPrm; static S16 insTempSeg3ThresPrm; static S16 insTempSeg4ThresPrm; static S16 insTempSeg5ThresPrm; static S16 insTempSeg6ThresPrm; static S16 insTempSeg7ThresPrm; static S16 insTempSeg8ThresPrm; static U8 insTempDisplayHysPrm;  /************************************************** *Function :WFM_Init *Description: WFM Module Inital *Parameters:none *Returns: none **create&Verlog: *Author Name xs Date:2017-6-22 Ver:2.0 ***************************************************/ void WFM_Init(void) { wfm_InitSts = FALSE; wfm_WTFault = 0; wfm_fuelSeg = 0; wfm_TmptSeg = 0; wfm_InvalidFltTmptSeg = 0; wfm_ecmNodeMiss = FALSE;  wfm_DisplayFuel = 0; wfm_NetEnClntTemV = INVALID; wfm_NetEnClntTem = 0; wfm_NetFuelTotCapct = FUEL_CAPACITY_MAX; wfm_InitSts = TRUE; wfm_WrnngProssPRO = 0; wfm_fuelsnsflt = 0; wfm_Cycle = STATE_CYCLE_NORMAL; insFuelSeg1ThresPrm = DIAG_GetFuelSeg1Thres(); insFuelSeg2ThresPrm = DIAG_GetFuelSeg2Thres(); insFuelSeg3ThresPrm = DIAG_GetFuelSeg3Thres(); insFuelSeg4ThresPrm = DIAG_GetFuelSeg4Thres(); insFuelSeg5ThresPrm = DIAG_GetFuelSeg5Thres(); insFuelSeg6ThresPrm = DIAG_GetFuelSeg6Thres(); insFuelSeg7ThresPrm = DIAG_GetFuelSeg7Thres(); insFuelSeg8ThresPrm = DIAG_GetFuelSeg8Thres(); insTempSeg2ThresPrm = DIAG_GetTempSeg2Thres();  insTempSeg3ThresPrm = DIAG_GetTempSeg3Thres();  insTempSeg4ThresPrm = DIAG_GetTempSeg4Thres();  insTempSeg5ThresPrm = DIAG_GetTempSeg5Thres(); insTempSeg6ThresPrm = DIAG_GetTempSeg6Thres();  insTempSeg7ThresPrm = DIAG_GetTempSeg7Thres();  insTempSeg8ThresPrm = DIAG_GetTempSeg8Thres(); insTempDisplayHysPrm = DIAG_GetTempDisplayHys(); wfm_InitSts = TRUE; }  /************************************************** *Function :WFM_Process_20ms *Description: WFM Module Process *Parameters:none *Returns: none **create&Verlog: *Author Name xs Date:2017-6-22 Ver:2.0 ***************************************************/ void WFM_Process_20ms(void) { if(TRUE == wfm_InitSts) { wfm_WrnngProssPRO ++;  if(WFM_WRNNG_PERIOD_CNT <= wfm_WrnngProssPRO) { wfm_WrnngProssPRO = 0; NWD_GetNodeMissing(INDEX_ECM_NODE,&wfm_ecmNodeMiss); wfm_FuelSegmentProcess(); wfm_WaterSegmentProcess(); wfm_WaterInvalidFltProcess(); wfm_coolantInvalidSegProcess();  wfm_FuelSensorOutRang_Process(); wfm_Process_Flt_Segment_process(); } else { /*do nothing*/ } } else { /*do nothing*/ } }  /************************************************** *Function :wfm_FuelSegmentProcess *Description: Process Fuel Information,SEG calculate,Fault detect,.etc *Parameters:none *Returns: NONE  **create&Verlog: *Author Name xs Date:2017-6-22 Ver:2.0 ***************************************************/ static void wfm_FuelSegmentProcess( void ) { U8 res; U8 mode;  //res = PWR_GetPwrMode(&mode); //if ((RET_OK == res) && ((PWR_CRANK == mode) || (PWR_RUN ==mode))) if (TRUE == wfm_InitSts) { /*process fuel and water temperature internal*/ wfm_DisplayFuel = FL_GetDisplayFuel(); /*SEG CALCULATE*/ if (wfm_DisplayFuel < insFuelSeg1ThresPrm) { wfm_fuelSeg = LEVEL_WFM_SEGNONE; } else if ((wfm_DisplayFuel >= insFuelSeg1ThresPrm) && (wfm_DisplayFuel < insFuelSeg2ThresPrm)) { wfm_fuelSeg = LEVEL_WFM_SEG1; } else if ((wfm_DisplayFuel >= insFuelSeg2ThresPrm) && (wfm_DisplayFuel < insFuelSeg3ThresPrm)) { wfm_fuelSeg = LEVEL_WFM_SEG2; } else if ((wfm_DisplayFuel >= insFuelSeg3ThresPrm) && (wfm_DisplayFuel < insFuelSeg4ThresPrm)) { wfm_fuelSeg = LEVEL_WFM_SEG3; } else if ((wfm_DisplayFuel >= insFuelSeg4ThresPrm) && (wfm_DisplayFuel < insFuelSeg5ThresPrm)) { wfm_fuelSeg = LEVEL_WFM_SEG4; } else if ((wfm_DisplayFuel >= insFuelSeg5ThresPrm) && (wfm_DisplayFuel < insFuelSeg6ThresPrm)) { wfm_fuelSeg = LEVEL_WFM_SEG5; } else if ((wfm_DisplayFuel >= insFuelSeg6ThresPrm) && (wfm_DisplayFuel < insFuelSeg7ThresPrm)) { wfm_fuelSeg = LEVEL_WFM_SEG6; } else if ((wfm_DisplayFuel >= insFuelSeg7ThresPrm) && (wfm_DisplayFuel < insFuelSeg8ThresPrm)) { wfm_fuelSeg = LEVEL_WFM_SEG7; } else { wfm_fuelSeg = LEVEL_WFM_SEG8; }  /*NetWork output value update*/ wfm_NetClstrDspdFuelLvlSgmt = wfm_fuelSeg;   /*FAULT DETECT*/ if(LEVEL_WFM_SEGNONE == wfm_fuelSeg) { wfm_FuelFault = TYPE_WARN_FUEL_CRITICAL; } else if(LEVEL_WFM_SEG1== wfm_fuelSeg) { wfm_FuelFault = TYPE_WARN_FUEL_LOW; } else { wfm_FuelFault = TYPE_WARN_FUEL_OK; } } else { wfm_fuelSeg = LEVEL_WFM_ALL; wfm_FuelFault = TYPE_WARN_FUEL_OK; } }  /************************************************** *Function :led_WaterSegmentProcess *Description: Process water temperature Information,SEG calculate,Fault detect,.etc *Parameters:none *Returns: NONE  **create&Verlog: *Author Name xs Date:2017-6-22 Ver:2.0 ***************************************************/ static void wfm_WaterSegmentProcess( void) { U8 res; U8 mode; S16 Value; static BOOL isDec = FALSE; U8 threshHold = 0;  res = PWR_GetPwrMode(&mode); COM_GetSignalValue_16(INDEX_COM_RS_ENCLNTTEM, (&Value)); COM_GetSignalValue_8(INDEX_COM_RS_ENCLNTTEMV, &wfm_NetEnClntTemV);  if ((RET_OK == res) && ((PWR_CRANK == mode) || (PWR_RUN ==mode))) { if(Value - wfm_NetEnClntTem > 0) { isDec = FALSE; } else { } if(Value - wfm_NetEnClntTem < 0) { isDec = TRUE; } else { }  if(TRUE == isDec) { threshHold = insTempDisplayHysPrm; } else { threshHold = 0; }  wfm_NetEnClntTem = Value;  if((VALID == wfm_NetEnClntTemV) && (FALSE == wfm_ecmNodeMiss)) { if(wfm_NetEnClntTem < insTempSeg2ThresPrm - threshHold) { wfm_TmptSeg = LEVEL_WFM_SEG1; } else if(wfm_NetEnClntTem < insTempSeg3ThresPrm - threshHold) { wfm_TmptSeg = LEVEL_WFM_SEG2; } else if(wfm_NetEnClntTem < insTempSeg4ThresPrm - threshHold) { wfm_TmptSeg = LEVEL_WFM_SEG3; } else if(wfm_NetEnClntTem<insTempSeg5ThresPrm - threshHold) { wfm_TmptSeg = LEVEL_WFM_SEG4; } else if(wfm_NetEnClntTem < insTempSeg6ThresPrm - threshHold) { wfm_TmptSeg = LEVEL_WFM_SEG5; } else if(wfm_NetEnClntTem < insTempSeg7ThresPrm - threshHold) { wfm_TmptSeg = LEVEL_WFM_SEG6; } else if(wfm_NetEnClntTem < insTempSeg8ThresPrm - threshHold) { wfm_TmptSeg = LEVEL_WFM_SEG7; } else { wfm_TmptSeg = LEVEL_WFM_SEG8; }    } else { /*do nothing*/ if(TRUE == wfm_ecmNodeMiss) { wfm_TmptSeg = LEVEL_WFM_SEGNONE; } else { } } /*FAULT DETECT*/ if(LEVEL_WFM_SEG8 == wfm_TmptSeg) { wfm_WTFault = TYPE_WARN_TEMP_CRITICAL; } else if(LEVEL_WFM_SEG7 == wfm_TmptSeg) { wfm_WTFault = TYPE_WARN_TEMP_HIGH; } else { wfm_WTFault = TYPE_WARN_TEMP_OK; } } else { wfm_TmptSeg = LEVEL_WFM_ALL; wfm_WTFault = TYPE_WARN_TEMP_OK; }  }  /************************************************** *Function :wfm_WaterInvalidFltProcess *Description: Water Invalid Flt Process *Parameters:none *Returns: NONE  **create&Verlog: *Author Name xs Date:2017-6-22 Ver:2.0 ***************************************************/ static void wfm_WaterInvalidFltProcess(void) { static U16 cur_cnt = 0;  if(INVALID == wfm_NetEnClntTemV) { cur_cnt ++; if(WFM_WATERINVALIDFLT_CNT <= cur_cnt) { cur_cnt = 0; wfm_coolantInvalidFlt = TRUE; } else { } } else {  cur_cnt = 0;  wfm_coolantInvalidFlt = FALSE; } }  /************************************************** *Function :wfm_coolantInvalidSegProcess *Description: Coolant Invalid Flt Process *Parameters:none *Returns: NONE  **create&Verlog: *Author Name xs Date:2017-6-22 Ver:2.0 ***************************************************/ static void wfm_coolantInvalidSegProcess(void) {  U8 res; U8 mode; static U8 TempCnt = 0; res = PWR_GetPwrMode(&mode);   if(TRUE == wfm_coolantInvalidFlt) { if ((RET_OK == res)  && ((PWR_CRANK == mode) || (PWR_RUN ==mode))) { if(wfm_InvalidFltTmptSeg !=0) { TempCnt ++; if(WFM_TEMP_NODEMISSING_LEDOFF_CNT < TempCnt) { TempCnt = 0; wfm_InvalidFltTmptSeg --; } } else { TempCnt = 0; } } else { wfm_InvalidFltTmptSeg = 0; TempCnt = 0; } } else { wfm_InvalidFltTmptSeg = wfm_TmptSeg; TempCnt = 0; } } /************************************************** *Function :WFM_SendNetSignal_50ms *Description: send fuel and temperature display signal 1.wfm_NetClstrDspdFuelLvlSgmt 2.wfm_NetFuelTotCapct 3.ClstrDspdFuelSts  *Parameters: NONE *Returns: NONE  **create&Verlog: *Author Name xs Date:2017-6-22 Ver:2.0 ***************************************************/ void WFM_SendNetSignal_50ms(void) { U8 fuelWrn = 0;  v_wr_8(ClstrDspdFuelLvlSgmt_handle, wfm_NetClstrDspdFuelLvlSgmt);   if(TYPE_WARN_FUEL_OK != wfm_FuelFault) { fuelWrn = 1; } else { }  v_wr_8(ClstrDspdFuelSts_handle, wfm_FuelFault); v_wr_8(ClstrDspdFuelSnsrWrnng_handle, fuelWrn); v_wr_16(FuelTotCapct_handle, wfm_NetFuelTotCapct*WFM_FUELCAP_SCALE); }  /************************************************** *Function :wfm_Process_Flt_Segment_process *Description: when bat is low or high,close fuel and temp seg *Parameters: NONE *Returns: NONE  **create&Verlog: *Author Name xs Date:2017-6-22 Ver:2.0 ***************************************************/ static void wfm_Process_Flt_Segment_process(void) { U8 status; U8 ret = 0;  ret = BAT_GetBatFltSts(TYPE_BATDET_TD,&status);  if(RET_OK == ret) { if((FLT_BAT_VOL_HIGH == status) ||(FLT_BAT_VOL_LOW == status)) { wfm_fuelSeg = LEVEL_WFM_SEGNONE; wfm_TmptSeg = LEVEL_WFM_SEGNONE; } else if(TRUE == FL_GetFuelSensorFaultFlag()) { wfm_fuelSeg = LEVEL_WFM_SEGNONE; } else { /*do nothing*/ } } else { /*do nothing*/ } }  /************************************************** *Function :wfm_FuelSensorOutRang_Flt_Process *Description: send the Temp Fault status  *Parameters: Sts *Returns: wfm_WTFault  **create&Verlog: *Author Name xs Date:2017-6-22 Ver:2.0 ***************************************************/ static void wfm_FuelSensorOutRang_Process(void) { U8 res,PwrMode = PWR_OFF; static U8 SensorFlt = 0; static U8 wfm_PwrMode = PWR_OFF;  res = PWR_GetPwrMode(&PwrMode); if(RET_OK == res) {  if(FALSE == FL_GetFuelSensorFaultFlag()) { wfm_Cycle = STATE_CYCLE_NORMAL; } else if((TRUE == FL_GetFuelSensorFaultFlag())  && (FALSE == SensorFlt) && ((PWR_RUN == PwrMode) || (PWR_CRANK== PwrMode))) { wfm_Cycle = STATE_CYCLE_CURRENT; } else { }  SensorFlt = FL_GetFuelSensorFaultFlag();  if(((PWR_RUN == PwrMode) ||(PWR_CRANK== PwrMode))  && ((PWR_ACC == wfm_PwrMode) ||(PWR_OFF== wfm_PwrMode))) { if(TRUE == FL_GetFuelSensorFaultFlag()  && (STATE_CYCLE_CURRENT ==wfm_Cycle)) { wfm_Cycle = STATE_CYCLE_NEXT; } else { } } else { } } wfm_PwrMode = PwrMode; } /************************************************** *Function :WFM_GetTpmsFltStatus *Description: send the Temp Fault status  *Parameters: Sts *Returns: wfm_WTFault  **create&Verlog: *Author Name xs Date:2017-6-22 Ver:2.0 ***************************************************/ U8 WFM_GetTempFltStatus(PU8 Sts) { U8 res = RET_FAIL;  if (FALSE == wfm_InitSts) { res = RET_FAIL; } else if (NULL_PTR == Sts) { res = RET_INVALID; } else { *Sts = wfm_WTFault; res = RET_OK; }  return res; }  /************************************************** *Function :WFM_GetFuelFltStatus *Description: send the Fuel Fault status  *Parameters: Sts *Returns: wfm_FuelFault  **create&Verlog: *Author Name xs Date:2017-6-22 Ver:2.0 ***************************************************/ U8 WFM_GetFuelFltStatus(PU8 Sts) { U8 res = RET_FAIL;  if (FALSE == wfm_InitSts) { res = RET_FAIL; } else if (NULL_PTR == Sts) { res = RET_INVALID; } else { *Sts = wfm_FuelFault; res = RET_OK; }  return res; }  /************************************************** *Function :WFM_GetCoolantSegmentNum *Description: send the info aboat TMP which seg have been lighted  *Parameters: pNum *Returns: wfm_TmptSeg  **create&Verlog: *Author Name xs Date:2017-6-22 Ver:2.0 ***************************************************/ U8 WFM_GetCoolantSegmentNum(PU8 pNum) { U8 res = RET_FAIL; U8 checksts; BOOL busOffFlt = FALSE;  if (FALSE == wfm_InitSts) { res = RET_FAIL; } else if (NULL_PTR == pNum) { res = RET_INVALID; } else { res = PWR_GetChkStatus(&checksts); busOffFlt = NWD_GetBusOffFlt(); switch(checksts) {  case STATUS_SLFCHK_ING:  case STATUS_SLFCHK_NOT_READY:  *pNum = 0; break; case STATUS_SLFCHK_FINISH:  if(TRUE == busOffFlt) { *pNum = 0; } else if(TRUE == wfm_coolantInvalidFlt) { *pNum = wfm_InvalidFltTmptSeg; } else { *pNum = wfm_TmptSeg; } break; }  res = RET_OK; }  return res; }  /************************************************** *Function :WFM_GetFuelSegmentNum *Description: send the info aboat FUEL which seg have been lighted  *Parameters: pNum *Returns: wfm_fuelSeg  **create&Verlog: *Author Name xs Date:2017-6-22 Ver:2.0 ***************************************************/ U8 WFM_GetFuelSegmentNum(PU8 pNum) { U8 res = RET_FAIL; U8 checksts = 0; BOOL busOffFlt = FALSE;  if (FALSE == wfm_InitSts) { res = RET_FAIL; } else if (NULL_PTR == pNum) { res = RET_INVALID; } else { res = PWR_GetChkStatus(&checksts); busOffFlt = NWD_GetBusOffFlt(); switch(checksts) {  case STATUS_SLFCHK_ING:  case STATUS_SLFCHK_NOT_READY:  *pNum = 0; break; case STATUS_SLFCHK_FINISH: if(FALSE == busOffFlt) { *pNum = wfm_fuelSeg; } else { *pNum = 0; }  break; }  res = RET_OK; }  return res; }  /************************************************** *Function :WFM_GetFuelSegmentNum *Description: send the info aboat FUEL which seg have been lighted  *Parameters: pNum *Returns: wfm_fuelSeg  **create&Verlog: *Author Name xs Date:2017-6-22 Ver:2.0 ***************************************************/ U8 WFM_GetCoolantTemp(PU8 pValue) { U8 res = RET_FAIL;  if (FALSE == wfm_InitSts) { res = RET_FAIL; } else if (NULL_PTR == pValue) { res = RET_INVALID; } else {  *pValue = wfm_NetEnClntTem;  res = RET_OK; }  return res; }  /************************************************** *Function :WFM_GetCoolantSensorFltSts *Description: send the info aboat FUEL which seg have been lighted  *Parameters: psts *Returns: ret  **create&Verlog: *Author Name liuyingying Date:2017-09-13 Ver:2.0 ***************************************************/ U8 WFM_GetCoolantSensorFltSts(PU8 SrFlt,PU8 pnodeMiss) {  U8 res = RET_FAIL;  if (FALSE == wfm_InitSts) { res = RET_FAIL; } else if ((NULL_PTR == SrFlt)||(NULL_PTR == pnodeMiss)) { res = RET_INVALID; } else { *SrFlt = wfm_coolantInvalidFlt;  *pnodeMiss = wfm_ecmNodeMiss; res = RET_OK; }  return res; }  /************************************************** *Function :WFM_GetFuelSensorCycle *Description: Get Fuel Sensor Cycle  *Parameters: none *Returns: cycle Value  **create&Verlog: *Author Name liuyingying Date:2017-09-13 Ver:2.0 ***************************************************/ U8 WFM_GetFuelSensorCycle(void) { return wfm_Cycle; } /*=========================================================================== wfm.c wfm_cfg.h wfm_info.inc wfm_private.h wfm_public.h File Revision History(bottom to top:first revision to last revision) *============================================================================ wfm.c wfm_cfg.h wfm_info.inc wfm_private.h wfm_public.h $Log:$ * wfm.c wfm_cfg.h wfm_info.inc wfm_private.h wfm_public.h Rev2: Userid:zxx Date:20170703 Description:initial *-------- ---------- --------- ------------------------------ * wfm.c wfm_cfg.h wfm_info.inc wfm_private.h wfm_public.h V2.0 xs 2017-6-22 Initial * *===========================================================================*/
