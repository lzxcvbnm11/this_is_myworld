/***************************************************************************** TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Copyright (C) 2016 ShenZhen Yeedon Media co.,LTD. All rights reserved. * TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h File Name : tip.c TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Description : TIP API application TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Author: Hejianjun TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Date: 2016-11-30 ******************************************************************************/  /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr Files for including */ #include "tip_info.inc"  static U8 tip_InitSts = FALSE; /*TIPµÄ³õÊ¼»¯±äÁ¿*/ /*»ñÈ¡Ïû¶¶ºóµÄTIP ADÖµ*/ static TIPKeySts_ST tip_KeyStatus = STATUS_TIP_SPORTOFF; /*´æ´¢°´¼ü×´Ì¬µÄ½á¹¹Ìå±äÁ¿*/ static BOOL tip_WinterKeySts = STATUS_IOM_HIGH; /*´æ´¢¶¬¼¾Ä±äÁ¿£Ê½¿ª¹Ø×´Ì¬µÄ*/ static TIPSendNetData_ST tip_NetOPSSignal; /*´æ´¢·¢ËÍµÄÍøÂçÐÅºÅ½á¹¹Ìå*/   static U16 FltCntRang = 0; static U16 FltCntstuck = 0; static U16 FltCntIllegal = 0; static TIPFlt_ST TipFlt;  /*************************************************** TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Function: TIP_Init TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Description: TIP module initialized TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Parameters: none TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Returns: none TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h $Create & Verlog:$ TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Author:Hejianjun Date:2016-11-30 Version:V1.0 ****************************************************/ void TIP_Init(void) { tip_KeyStatus.status = STATUS_TIP_SPORTOFF; tip_WinterKeySts = STATUS_IOM_HIGH; tip_NetOPSSignal.TrPfShftPtrnSw1A = FALSE; tip_NetOPSSignal.TrPfShftPtrnSw4A = FALSE; tip_NetOPSSignal.PfTrTapUpDwnEnbSwSta = 0u; tip_NetOPSSignal.PfTrTapUpDwnSwSta = 0u; tip_NetOPSSignal.PfTrRollingCnt = 0u; tip_NetOPSSignal.TrPfRollingCnt = 0u; TipFlt.OutRang = FALSE; TipFlt.Stuck = FALSE; TipFlt.Illeagal = FALSE;  tip_InitSts = ((ADM_GetInitStatus()) && (IOM_GetModuleStatus())); }  /*************************************************** TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Function: TIP_Process_20ms TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Description: the process of the TIP module TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Parameters: none TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Returns: none TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h $Create & Verlog:$ TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Author:Hejianjun Date:2016-11-30 Version:V1.0 ****************************************************/ void TIP_Process_20ms(void) { U8 batSts = 0;  if (TRUE == tip_InitSts) { BAT_GetBatFltSts(TYPE_BATDET_CLASSA,&batSts); if(FLT_BAT_NO == batSts) { tip_LocalProcess(); } else { } tip_Rollingcnt(); } else { tip_NetOPSSignal.TrPfShftPtrnSw1A = FALSE; tip_NetOPSSignal.TrPfShftPtrnSw4A = FALSE; tip_NetOPSSignal.PfTrTapUpDwnEnbSwSta = 0u; tip_NetOPSSignal.PfTrTapUpDwnSwSta = 0u; tip_NetOPSSignal.PfTrRollingCnt = 0u; tip_NetOPSSignal.TrPfRollingCnt = 0u; }  }  /*************************************************** TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Function: tip_SerachKeySts TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Description: check the status of tip switch TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Parameters: none TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Returns: TRUE or FALSE TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h $Create & Verlog:$ TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Author:Hejianjun Date:2016-11-30 Version:V1.0 ****************************************************/ static void tip_SerachKeySts(void) { U16 advalue = 0; BOOL keysts = STATUS_IOM_HIGH; TIPKeyStatus_ENUM tipKeySts = STATUS_TIP_SPORTOFF;  if (RET_OK == IOM_GetInputLevel(INDEX_IOINTPUT_WINTERMODE, &keysts)) { tip_WinterKeySts = keysts; } else { }   if (RET_OK == ADM_GetDebounceValue(INDEX_ADM_LOCALTAPUPDOWN, &advalue)) {  if (ABS_SUB(advalue, TIP_SPORT_OFF) <= (TIP_OFFSETRANGE)) { tip_KeyStatus.status = STATUS_TIP_SPORTOFF;  } else if (ABS_SUB(advalue, TIP_SPORT_ON) <= (TIP_OFFSETRANGE)) { tip_KeyStatus.status = STATUS_TIP_SPORTON;  } else if (ABS_SUB(advalue, TIP_LOCAL_DOWN) <= (TIP_OFFSETRANGE)) { tip_KeyStatus.status = STATUS_TIP_TAPDOWNPRESS;  } else if (ABS_SUB(advalue, TIP_LOCAL_UP) <= (TIP_OFFSETRANGE)) { tip_KeyStatus.status = STATUS_TIP_TAPUPPRESS;  } else /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr out of range*/ { tip_KeyStatus.status = STATUS_TIP_OUTOFRANGE;  } } else { }    }  /*************************************************** TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Function: tip_TipStuckFaultDetect TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Description: detect outofrang fault TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Parameters: none TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Returns: TRUE or FALSE TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h $Create & Verlog:$ TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Author:huangxianxiang Date:2017-06-27 Version:V2.0 ****************************************************/ static void tip_OutOfRangFaultDetect(void) { static TIPKeyStatus_ENUM TipStsOutRang = STATUS_TIP_SPORTOFF;  if(TipStsOutRang != tip_KeyStatus.status) { FltCntRang = 0;  TipStsOutRang = tip_KeyStatus.status; } else { }  if(STATUS_TIP_OUTOFRANGE == tip_KeyStatus.status) {  if(TIP_OUTOFRANG_FLT_CNT <= FltCntRang) { TipFlt.OutRang = TRUE; } else { FltCntRang ++; } } else if(TRUE == TipFlt.OutRang) { if(TIP_OUTOFRANG_FLT_CNT <= FltCntRang) { TipFlt.OutRang = FALSE; FltCntRang = 0; } else { FltCntRang ++; } } else { } }  /*************************************************** TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Function: tip_TipStuckFaultDetect TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Description: detect stuck fault TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Parameters: none TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Returns: TRUE or FALSE TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h $Create & Verlog:$ TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Author:huangxianxiang Date:2017-06-27 Version:V2.0 ****************************************************/ static void tip_TipStuckFaultDetect(void) { static TIPKeyStatus_ENUM TipStsStuck = STATUS_TIP_SPORTOFF;  if(TipStsStuck != tip_KeyStatus.status) { FltCntstuck = 0; TipStsStuck = tip_KeyStatus.status; if(TRUE == TipFlt.Stuck) { TipFlt.Stuck= FALSE; } else { } } else { if(((STATUS_TIP_TAPDOWNPRESS == tip_KeyStatus.status)  || (STATUS_TIP_TAPUPPRESS == tip_KeyStatus.status))) { if(TIP_STUCK_FLT_CNT <= FltCntstuck) { TipFlt.Stuck= TRUE; } else { FltCntstuck ++; }  } else { } } }  /*************************************************** TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Function: tip_TipIllegalFaultDetect TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Description: detect illegal fault TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Parameters: none TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Returns: TRUE or FALSE TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h $Create & Verlog:$ TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Author:huangxianxiang Date:2017-06-27 Version:V2.0 ****************************************************/ static void tip_TipIllegalFaultDetect(void) { static TIPKeyStatus_ENUM TipStsIllegal = STATUS_TIP_SPORTOFF;  if(TipStsIllegal != tip_KeyStatus.status) { TipStsIllegal = tip_KeyStatus.status; FltCntIllegal = 0; } else { }  if(((STATUS_IOM_LOW== tip_WinterKeySts)&&(STATUS_TIP_SPORTON== tip_KeyStatus.status)) || ((STATUS_IOM_LOW== tip_WinterKeySts)&&(STATUS_TIP_TAPUPPRESS== tip_KeyStatus.status)) ||((STATUS_IOM_LOW== tip_WinterKeySts)&&(STATUS_TIP_TAPDOWNPRESS== tip_KeyStatus.status))) { if(TIP_ILLEGAL_FLT_CNT <= FltCntIllegal) { TipFlt.Illeagal = TRUE; FltCntIllegal = 0; } else { FltCntIllegal ++; } } else if(TRUE == TipFlt.Illeagal) { TipFlt.Illeagal = FALSE; } else { } }  /*************************************************** TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Function: tip_LocalProcess TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Description: serach Tip_Matrix table based on switch status TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Parameters: input TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h sts: TRUE or FALSE TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Returns: TRUE or FALSE TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h $Create & Verlog:$ TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Author:Hejianjun Date:2016-11-30 Version:V1.0 ****************************************************/ static void tip_LocalProcess(void) {  U8 i = 0;   tip_SerachKeySts();   tip_OutOfRangFaultDetect();  tip_TipStuckFaultDetect(); tip_TipIllegalFaultDetect();   if((FALSE ==TipFlt.Illeagal) && (FALSE ==TipFlt.Stuck) && (FALSE ==TipFlt.OutRang)) { for (i = 0; i < TIP_NETCONDITIONMAX; i++) { if ((Tip_Matrix[i].wintersts == tip_WinterKeySts) && (Tip_Matrix[i].val == tip_KeyStatus.status)) { tip_NetOPSSignal.PfTrTapUpDwnEnbSwSta = Tip_Matrix[i].EnbSwStaVal; tip_NetOPSSignal.PfTrTapUpDwnSwSta = Tip_Matrix[i].SwStaVal; tip_NetOPSSignal.TrPfShftPtrnSw1A = Tip_Matrix[i].SModeSts; tip_NetOPSSignal.TrPfShftPtrnSw4A = Tip_Matrix[i].WModeSts; } else { } } } else {  if(TRUE == TipFlt.OutRang) { tip_NetOPSSignal.PfTrTapUpDwnEnbSwSta = ACTIVE; tip_NetOPSSignal.PfTrTapUpDwnSwSta = ACTIVE; tip_NetOPSSignal.TrPfShftPtrnSw1A = FALSE; } else { }  if(TRUE == TipFlt.Illeagal) { tip_NetOPSSignal.TrPfShftPtrnSw1A = FALSE; tip_NetOPSSignal.TrPfShftPtrnSw4A = FALSE; }  else { } } }  /*************************************************** TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Function: TIP_SendNetSignal_10ms TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Description: send net signal TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Parameters: input: none TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Returns: none TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h $Create & Verlog:$ TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Author:Hejianjun Date:2016-11-29 Version:V1.0 ****************************************************/ void TIP_SendNetSignal_10ms(void) {  if(TRUE ==TipFlt.Illeagal) { v_wr_bool(TrPfShftPtrnSw1A_handle, FALSE); /*need update signal handle*/ v_wr_bool(TrPfShftPtrnSw4A_handle, FALSE); } else { v_wr_bool(TrPfShftPtrnSw1A_handle, tip_NetOPSSignal.TrPfShftPtrnSw1A); /*need update signal handle*/ v_wr_bool(TrPfShftPtrnSw4A_handle, tip_NetOPSSignal.TrPfShftPtrnSw4A); }  if(TRUE == TipFlt.OutRang) {  v_wr_bool(TrPfShftPtrnSw1A_handle, FALSE); v_wr_8(PfTrTapUpDwnEnbSwSta_handle, TIP_ILLEGALENABLE); v_wr_8(PfTrTapUpDwnSwSta_handle, TIP_ILLEGALENABLE); } else { v_wr_8(PfTrTapUpDwnEnbSwSta_handle, tip_NetOPSSignal.PfTrTapUpDwnEnbSwSta); v_wr_8(PfTrTapUpDwnSwSta_handle, tip_NetOPSSignal.PfTrTapUpDwnSwSta); }   v_wr_8(PfTrTapUpDwnSwStsAlvRC_handle, tip_NetOPSSignal.PfTrRollingCnt);  v_wr_8(TrPfShftPtrnSwAlvRC_handle, tip_NetOPSSignal.TrPfRollingCnt); }  /*************************************************** TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Function: tip_Rollingcnt TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Description: Rollingcnt signal update TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Parameters: input: none TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Returns: none TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h $Create & Verlog:$ TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Author:Hejianjun Date:2016-11-29 Version:V1.0 ****************************************************/ static void tip_Rollingcnt(void) { static U8 RollCntPftr = 0; static U8 RollCntTrpf = 0;  if (FALSE != v_test_flag(tiprollcntPftr_handle)) { RollCntPftr++; RollCntPftr = RollCntPftr & 0x03; tip_NetOPSSignal.PfTrRollingCnt = RollCntPftr; } else {  } v_clear_flag(tiprollcntPftr_handle);  if (FALSE != v_test_flag(tiprollcntTrpf_handle)) { RollCntTrpf++; RollCntTrpf = RollCntTrpf & 0x03; tip_NetOPSSignal.TrPfRollingCnt = RollCntTrpf;  } else {  } v_clear_flag(tiprollcntTrpf_handle); }  /*************************************************** TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Function: TIP_GetFltStatus TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Description: get tip error status TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Parameters: output:  TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Returns:  RET_INVALID RET_FAIL TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h $Create & Verlog:$ TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Author:Hejianjun Date:2016-11-29 Version:V1.0 ****************************************************/ U8 TIP_GetFltStatus(TIPFlt_ST *status) { U8 res; if (NULL_PTR == status) { res = RET_INVALID; } else { if (TRUE == tip_InitSts) { *status = TipFlt; } else { res = RET_FAIL; } } return res; } /*=========================================================================== TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h File Revision History(bottom to top:first revision to last revision) *============================================================================ TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h $Log:$ * TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h Rev: Userid: Date: Description *-------- ---------- --------- ------------------------------ * TIP å¼€å…³ç”µè·¯ç”µåŽ‹.xlsx tip.c tip_cfg.h tip_info.inc tip_private.h tip_public.h V1.0 Hejianjun 2016-11-30 Initial * *===========================================================================*/
