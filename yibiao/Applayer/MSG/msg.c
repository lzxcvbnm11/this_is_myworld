/***************************************************************************** msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Copyright (C) 2016 ShenZhen Yeedon Media co.,LTD. All rights reserved. * msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h File Name : msg.c msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Description : msg module middleware msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Author: Yingying.Liu msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Date: 2016-12-2 ******************************************************************************/  /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr Files for including */ #include "msg_info.inc"   static U8 msg_InitSts = FALSE; static U16 msg_DisplayCnt = 0; static U16 msg_DisplayMinCnt = 0; static U16 msg_GCounter_5s = 0;  static BOOL msg_JudgeFinishFlag[INDEX_GJ_ALL]; /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr 当前发生的最高优先级事件 */ static EVT_GETJUDGE_ENUM msg_JudgeIndex; static MSG_EVENT_ENUM msg_curMsgIndex; static JudgeEvtData_ST msg_stCurEvt;   static U8 insEchoMesPeriodPrm = 0; static U8 insEchoMesMinPeriodPrm = 0;  /*************************************************** msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Function: msg_Init msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Description: msg module initialized msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Parameters: none msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Returns: none msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h $Create & Verlog:$ msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Author:Yingying.Liu Date:2016-12-2 Version:V1.0 ****************************************************/ void MSG_Init(void) { U8 k = 0;  insEchoMesMinPeriodPrm = DIAG_GetEchoMesMinPeriod(); insEchoMesPeriodPrm = DIAG_GetEchoMesPeriod();  if(insEchoMesPeriodPrm < insEchoMesMinPeriodPrm) { insEchoMesPeriodPrm = insEchoMesMinPeriodPrm; } else { }  msg_DisplayCnt = ((S_TO_MS(insEchoMesPeriodPrm))/MSG_PROCESS_PERIOD ); msg_DisplayMinCnt = ((S_TO_MS(insEchoMesMinPeriodPrm))/MSG_PROCESS_PERIOD);  msg_GCounter_5s = msg_DisplayMinCnt;  msg_stCurEvt.index = INDEX_GJ_NULL; msg_stCurEvt.event.msg = INDEX_MSG_NULL; msg_stCurEvt.event.warn = INDEX_WARN_NULL; msg_stCurEvt.event.led = INDEX_LED_NULL; msg_curMsgIndex = INDEX_MSG_NULL; msg_JudgeIndex = INDEX_GJ_NULL;  msg_SetWorkStatus(FALSE,msg_curMsgIndex);  for (k = INDEX_GJ_NULL; k < INDEX_GJ_ALL; k++) { msg_JudgeFinishFlag[k] = 0; }  msg_InitSts = TRUE; }  /*************************************************** msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Function: MSG_Process_5ms msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Description:Msg Module Process msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Parameters:none msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Returns: none msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h $Create & Verlog:$ msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Author:Yingying.Liu Date:2016-12-2 Version:V1.0 ****************************************************/ void MSG_Process_5ms(void) { U8 res = 0; U8 mode = 0; U8 selfChk = 0;  U8 state = 0; static U8 slfcnt = 0; JudgeEvtData_ST judgeevt;   res = PWR_GetChkStatus(&selfChk); PWR_GetPwrMode(&mode);  if ((TRUE == msg_InitSts) && (RET_OK == res)) {  switch(selfChk) { case STATUS_SLFCHK_ING: slfcnt =0;  msg_GCounter_5s = msg_DisplayCnt; msg_JudgeIndex = INDEX_GJ_NULL;   msg_SetWorkStatus(FALSE,INDEX_MSG_NULL); break;  case STATUS_SLFCHK_NOT_READY:  case STATUS_SLFCHK_FINISH: default: if (MSG_SELFCHECK_CNT > slfcnt)  { slfcnt++; } else { }  if (ILLU_GetWelComeSts()) { break; } else { }  res = EVT_GetPriorEvent(&msg_stCurEvt); switch (msg_curMsgIndex) { case INDEX_MSG_LIGHT: case INDEX_MSG_IGNKEY: case INDEX_MSG_SRS: case INDEX_MSG_HEADLAMP: case INDEX_MSG_KEY_NOTFOUND: case INDEX_MSG_WELCOME: case INDEX_MSG_CLUTCHMT_ON: case INDEX_MSG_NOKEYCLTHSTART_ON: case INDEX_MSG_NOKEYBRKSTART_ON: case INDEX_MSG_BCMTAKESMTKEYOUTOFSR_ON: case INDEX_MSG_SHFTPARKRMNDR_ON: case INDEX_MSG_PUTSMTKEYTOBKUPPOSR_ON: case INDEX_MSG_DRVRWNDOPENRMNDR_ON: case INDEX_MSG_SRFOPENRMNDR_ON: case INDEX_MSG_PEPSANTFLT_ON: case INDEX_MSG_DOORANDLID_BONNET_L5: case INDEX_MSG_DOORANDLID_DOOR_L5: case INDEX_MSG_DOORANDLID_LDSP_L5: break;  default:  if ((PWR_ACC == mode) || (PWR_OFF == mode))  { msg_GCounter_5s = msg_DisplayCnt; if (MSG_SELFCHECK_CNT > slfcnt)  { return; }  } else { } break; }   if(INDEX_MSG_NULL == msg_JudgeIndex) { msg_GCounter_5s = msg_DisplayMinCnt + 1; } else { msg_GCounter_5s ++; }  if (msg_GCounter_5s > msg_DisplayMinCnt) { if (msg_stCurEvt.index != msg_JudgeIndex)  { msg_SetWorkStatus(TRUE, msg_stCurEvt.event.msg); } else { /*if msg is class b ,will never exist , (not include INDEX_MSG_IGNKEY)*/ if (PRIY_MSG_CLASS_B == MsgPriyTab[msg_stCurEvt.event.msg]) { msg_curMsgIndex = msg_stCurEvt.event.msg; if(msg_curMsgIndex != INDEX_MSG_IGNKEY) { msg_GCounter_5s = msg_DisplayCnt; } else { } } else { }  /*if msg changed,here should set new msg as  the current msg*/  if ((INDEX_MSG_NULL != msg_curMsgIndex)  && (msg_curMsgIndex != msg_stCurEvt.event.msg)) { CHM_SetJudgeIndex(INDEX_GJ_NULL); msg_SetWorkStatus(TRUE,msg_stCurEvt.event.msg);  } else { }  }  /*if class c or INDEX_MSG_IGNKEY msg is reached max cnt here should exist msg display */ if (msg_GCounter_5s > msg_DisplayCnt) { msg_JudgeFinishFlag[msg_JudgeIndex] = 0; CHM_GetChmEvtFinishStatus(msg_JudgeIndex,&state); if (0 == state)  { EVT_SetJudgeIndexFlagMap(msg_JudgeIndex);  } else { }  if (INDEX_MSG_NULL == msg_stCurEvt.event.msg)  { msg_JudgeIndex = INDEX_GJ_NULL;  } else { }  msg_SetWorkStatus(FALSE,INDEX_MSG_NULL);  } else { }   } else { }   switch (msg_curMsgIndex) { case INDEX_MSG_LIGHT: case INDEX_MSG_IGNKEY: case INDEX_MSG_SRS: case INDEX_MSG_HEADLAMP: case INDEX_MSG_KEY_NOTFOUND: case INDEX_MSG_WELCOME: case INDEX_MSG_CLUTCHMT_ON: case INDEX_MSG_NOKEYCLTHSTART_ON: case INDEX_MSG_NOKEYBRKSTART_ON: case INDEX_MSG_BCMTAKESMTKEYOUTOFSR_ON: case INDEX_MSG_SHFTPARKRMNDR_ON: case INDEX_MSG_PUTSMTKEYTOBKUPPOSR_ON: case INDEX_MSG_DRVRWNDOPENRMNDR_ON: case INDEX_MSG_SRFOPENRMNDR_ON: case INDEX_MSG_PEPSANTFLT_ON:  case INDEX_MSG_DOORANDLID_BONNET_L5: case INDEX_MSG_DOORANDLID_DOOR_L5: case INDEX_MSG_DOORANDLID_LDSP_L5: if ((PWR_ACC != mode)&&(PWR_OFF != mode)) { msg_SetWorkStatus(FALSE,msg_curMsgIndex); } else { } break;  default: break; } break; } } else { }  }   /*************************************************** msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Function: msg_SetWorkStatus msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Description:set msg work status msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Parameters: index:msg evt index status:TRUE or FALSE msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Returns: none msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h $Create & Verlog:$ msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Author:Yingying.Liu Date:2016-12-2 Version:V1.0 ****************************************************/ void msg_SetWorkStatus(BOOL status,MSG_EVENT_ENUM index) { if (TRUE == status) { msg_GCounter_5s = 0;  switch (index)  { case INDEX_MSG_IGNKEY: msg_DisplayCnt =(DIAG_GetIgnOffSpelWarnPeriod()*MSG_TIME_CNT_1S_FACTOR); break;  case INDEX_MSG_WELCOME:  default: msg_DisplayCnt = (insEchoMesPeriodPrm msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h MSG_TIME_CNT_1S_FACTOR); break; }  msg_JudgeIndex = msg_stCurEvt.index; msg_JudgeFinishFlag[msg_JudgeIndex] = 1;   EVT_JudgePushFaultEvt(&msg_stCurEvt);  }  else { } msg_curMsgIndex =index;  }   /*************************************************** msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Function: MSG_GetPopIndex msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Description:get popup msg index msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Parameters:index msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Returns:  RET_FAIL: INITIAL FAILED RET_INVALID:PARAMETER NOT AVALIABLE RET_OK: SUCCESS msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h $Create & Verlog:$ msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Author:Yingying.Liu Date:2016-12-2 Version:V1.0 ****************************************************/ U8 MSG_GetPopIndex(MSG_EVENT_ENUM *index) { U8 res = RET_OK;  if(FALSE == msg_InitSts) { res = RET_FAIL; } else if(NULL_PTR== index) { res = RET_INVALID; }  else { *index = msg_curMsgIndex; }  return res; }  /*************************************************** msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Function: MSG_GetJudgeIndex msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Description: msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Parameters:index EVT INDEX msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Returns:  RET_FAIL: INITIAL FAILED RET_INVALID:PARAMETER NOT AVALIABLE RET_OK: SUCCESS msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h $Create & Verlog:$ msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Author:Yingying.Liu Date:2017-10-30 Version:V1.0 ****************************************************/ U8 MSG_GetJudgeIndex(U8 index,PU8 pSts) {  U8 res = RET_OK; if(FALSE == msg_InitSts) {  res = RET_FAIL; } else if (INDEX_GJ_ALL <= index) {  res = RET_INVALID; } else { *pSts = msg_JudgeFinishFlag[index]; res = RET_OK; }  return res; }  /*************************************************** msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Function: MSG_GetJudgCurEevt msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Description: msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Parameters:judgeevt evt information structure msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Returns: RET_FAIL: INITIAL FAILED RET_INVALID:PARAMETER NOT AVALIABLE RET_OK: SUCCESS msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h $Create & Verlog:$ msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Author:Yingying.Liu Date:2017-10-30 Version:V1.0 ****************************************************/ U8 MSG_GetJudgCurEvt(JudgeEvtData_ST *judgeevt) { U8 res = RET_OK;  if (FALSE == msg_InitSts) { res = RET_FAIL; } else if (NULL_PTR == judgeevt) { res = RET_INVALID; }  else { *judgeevt =msg_stCurEvt; }  return RET_OK; }  /*=========================================================================== msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h File Revision History(bottom to top:first revision to last revision) *============================================================================ msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h $Log:$ * msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h Rev: Userid: Date: Description *-------- ---------- --------- ------------------------------ * msg.c msg_cfg.h msg_info.inc msg_private.h msg_public.h V1.0 Yingying.Liu 2016-12-2 Initial * *===========================================================================*/
