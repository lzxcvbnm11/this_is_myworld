/***************************************************************************** bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Copyright (C) 2016 ShenZhen Yeedon Media co.,LTD. All rights reserved. * bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx File Name : bat.c bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Description : BAT API application bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Author: ZXX bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Date: 2017-6-28 ******************************************************************************/  /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr Files for including */ #include "bat_info.inc"    /*************************************************** bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Function: BAT_Init bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Description: BAT module initialized bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Parameters: none bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Returns: none bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx $Create & Verlog:$ bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Author:Hejianjun Date:2016-12-05 Version:V1.0 bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Author:liuyingying Date:2017-06-27 Version:V2.0 *$log: initial variables ****************************************************/ void BAT_Init(void) { bat_ADCValue = 0u; bat_TD.status= 0; bat_TD.status_bak= 0; bat_TD.fltSts= FLT_BAT_NO; bat_TD.Remove_cnt= 0; bat_TD.Detect_cnt= 0;  bat_ClassA.status= 0; bat_ClassA.status_bak= 0; bat_ClassA.fltSts= FLT_BAT_NO; bat_ClassA.Remove_cnt= 0; bat_ClassA.Detect_cnt= 0;  bat_Lin.status= 0; bat_Lin.status_bak= 0; bat_Lin.fltSts= FLT_BAT_NO; bat_Lin.Remove_cnt= 0; bat_Lin.Detect_cnt= 0;  bat_Can.status= 0; bat_Can.status_bak= 0; bat_Can.fltSts= FLT_BAT_NO; bat_Can.Remove_cnt= 0; bat_Can.Detect_cnt= 0;  bcmBatValue = 0;  bat_stBcmBat.cnt = 0; bat_stBcmBat.debounceValue = 0; bat_stBcmBat.res = RET_OK; bat_stBcmBat.sum = 0; bat_stBcmBat.value = 0;  bat_InitSts = ADM_GetInitStatus(); }    /*************************************************** bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Function: BAT_Init bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Description: BAT module initialized bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Parameters: none bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Returns: none bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx $Create & Verlog:$ bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Author:Hejianjun Date:2016-12-05 Version:V1.0 bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Author:liuyingying Date:2017-06-27 Version:V2.0 *$log: initial variables ****************************************************/ U8 BAT_GetInitSts(void) { return bat_InitSts; }    /*************************************************** bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Function: BAT_Process_5ms bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Description: the process of the BAT module  bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Parameters: none bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Returns: none bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx $Create & Verlog:$ bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Author:liuyingying Date:2017-06-27 Version:V2.0 *$log: add new functions ****************************************************/ void BAT_Process_5ms(void) { U8 res = RET_OK; U8 i = 0; if (TRUE == bat_InitSts) { res = ADM_GetDebounceValue(INDEX_ADM_BATT, &bat_ADCValue); if(RET_OK == res) { for(i =0; i< TYPE_BATDET_ALL ; i ++) { bat_voltageRange_Process(i,batDectTab[i]);  bat_voltageRange_check(i,batDectTab[i]); } } else { } } else {  } }  void BAT_BcmBat_Process_100ms(void) { U8 bcmNodeMissing = FALSE; U16 bat_NetValue = 0; U16 range = 0; COM_GetSignalValue_16(INDEX_COM_RS_BATVOL,&bat_NetValue);  NWD_GetNodeMissing(INDEX_BCM_NODE,&bcmNodeMissing); if(TRUE == bcmNodeMissing) { bcmBatValue = 0; } else {  range = ABS_SUB(bat_NetValue,bat_stBcmBat.value); if (BCM_DEBOUNCE_OFFSET > range) { if (BCMBAT_DEBOUNCECNT <= bat_stBcmBat.cnt) { bat_stBcmBat.debounceValue = (bat_stBcmBat.sum /BCMBAT_DEBOUNCECNT); bat_stBcmBat.sum = 0; bat_stBcmBat.cnt = 0; bat_stBcmBat.res = RET_OK; } else { bat_stBcmBat.sum += bat_NetValue; bat_stBcmBat.cnt ++; } } else { bat_stBcmBat.cnt = 0; bat_stBcmBat.sum = 0; }  bat_stBcmBat.value = bat_NetValue;  if(BCM_BAT_NET_THRESHHOLD > bat_stBcmBat.debounceValue) { bcmBatValue=((bat_stBcmBat.debounceValue*BCM_BAT_NET_FACTOR)+BCM_BAT_NET_OFFSET); } else { bcmBatValue = bat_stBcmBat.debounceValue; } } } /*************************************************** bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Function: bat_voltageStatusProcess bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Description: procss bat status bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Parameters: none bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Returns: none bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx $Create & Verlog:$ bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Author:liuyingying Date:2017-06-27 Version:V2.0 *$log: check battery sts ****************************************************/ static void bat_voltageRange_Process(U8 Type,stBatDect_ST *pData) { U8 res = 0;  if(NULL_PTR == pData)  { return; }  switch (pData->fltSts)  { case LEVEL_BAT_HIGH: if(batVolRangTab[Type].highoff >= bat_ADCValue) { if(batVolRangTab[Type].lowon >= bat_ADCValue) { pData->status= LEVEL_BAT_LOW; } else { pData->status = FLT_BAT_NO; }  } else { pData->status = LEVEL_BAT_HIGH;  } break;  case LEVEL_BAT_LOW: if(batVolRangTab[Type].lowoff <= bat_ADCValue) { if(batVolRangTab[Type].highon <= bat_ADCValue) { pData->status = LEVEL_BAT_HIGH; } else { pData->status = FLT_BAT_NO; }  } else { pData->status = LEVEL_BAT_LOW;  } break;  case LEVEL_BAT_NORMAL: default: if(batVolRangTab[Type].highon <= bat_ADCValue) { pData->status = LEVEL_BAT_HIGH; } else if(batVolRangTab[Type].lowon >= bat_ADCValue) { pData->status = LEVEL_BAT_LOW; } else { pData->status = LEVEL_BAT_NORMAL;  }  break; } } /*************************************************** bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Function: bat_voltageFault_check bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Description: check the battery in fault status bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Parameters: none bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Returns: none bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx $Create & Verlog:$ bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Author:liuyingying Date:2017-06-27 Version:V2.0 ****************************************************/ static void bat_voltageRange_check(U8 Type,stBatDect_ST *pData) { if(NULL_PTR == pData)  { return; } else { }  if( pData->status_bak != pData->status) {  pData->Detect_cnt = 0; }  else { if(batVolRangTab[Type].fltMaxCnt <= pData->Detect_cnt) { pData->fltSts = pData->status; } else { pData->Detect_cnt ++; } } pData->status_bak = pData->status; }   /*************************************************** bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Function: BAT_GetBatLevel bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Description: check the battery status bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Parameters: output bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Returns: RET_FAIL RET_INVAILD RET_OK bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx $Create & Verlog:$ bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Author:liuyingying Date:2017-06-27 Version:V2.0 ****************************************************/ U8 BAT_GetBatValue(PU16 Value) { U8 res;  if (FALSE == bat_InitSts) { res = RET_FAIL; } else if (NULL_PTR == Value) { res = RET_INVALID; } else { *Value = bat_ADCValue; res = RET_OK;  } return res; }  /*************************************************** bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Function: BAT_GetBatLevel bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Description: check the battery status bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Parameters: output bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Returns: RET_FAIL RET_INVAILD RET_OK bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx $Create & Verlog:$ bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Author:liuyingying Date:2017-06-27 Version:V2.0 ****************************************************/ U8 BAT_GetBCMBatValue(PU16 pValue) { U8 res; U16 value;  if (FALSE == bat_InitSts) { res = RET_FAIL; } else if (NULL_PTR == pValue) { res = RET_INVALID; } else {  *pValue = bcmBatValue; res = RET_OK;  } return res; }  /*************************************************** bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Function: BAT_GetBatFltSts bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Description: check the battery status bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Parameters:  bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Returns: RET_FAIL RET_INVAILD RET_OK bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx $Create & Verlog:$ bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Author:liuyingying Date:2017-06-27 Version:V2.0 ****************************************************/ U8 BAT_GetBatFltSts(BatDect_Type_ENUM Type,PU8 sts) { U8 res =RET_OK;  if (FALSE == bat_InitSts) { res = RET_FAIL; } else if (NULL_PTR == sts) { res = RET_INVALID; } else { *sts = batDectTab[Type]->fltSts; } return res; }  /*=========================================================================== bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx File Revision History(bottom to top:first revision to last revision) *============================================================================ bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx $Log:$ * bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx Rev: Userid: Date: Description *-------- ---------- --------- ------------------------------ * bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx V1.0 Hejianjun 2016-12-05 Initial bat.c bat_cfg.h bat_info.inc bat_private.h bat_public.h ZS12_BAT_ADC_TAB.xlsx V2.0 liuyingying 2017-06-27 modify *===========================================================================*/
