/***************************************************************************** lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Copyright (C) 2016 ShenZhen Yeedon Media co.,LTD. All rights reserved. * lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h File Name : lrm.c lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Description : LRM module middleware lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Author: Xueping.Chen lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Date: 2016-11-26 ******************************************************************************/  /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr Files for including */ #include "lrm_info.inc"  static BOOL lrm_InitSts = FALSE; /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr LRM初始化默认值为FALSE */ static LRMState_UN lrm_LEDState; /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr LRM LED状态*/ static LrmWorkStatus_ENUM lrm_WorkStatus = STATUS_LRM_Z_State; /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr LRM工作状态默认为高阻状态*/   /*************************************************** lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Function: LRM_Init lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Description: LRM module initialized lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Parameters: none lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Returns: none lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h $Create & Verlog:$ lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Author:Xueping.Chen Date:2016-11-26 Version:V1.0 ****************************************************/ void LRM_Init(void) { U8 i = 0; lrm_InitSts = DIO_GetInitStatus(); lrm_WorkStatus = STATUS_LRM_Z_State; lrm_ControlSts(STATUS_LRM_Z_State);   for(i = 0; i < LRM_LAMP_ALL; i++) { lrm_LEDState.LRM_value[i] = 0; } }  /*************************************************** lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Function: LRM_Process_100ms lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Description: the process of the LRM module lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Parameters: none lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Returns: none lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h $Create & Verlog:$ lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Author:Xueping.Chen Date:2016-11-26 Version:V1.0 ****************************************************/ void LRM_Process_100ms(void) { LRMState_UN lrm_Status;  if (TRUE == lrm_InitSts) { if (RET_OK == LED_GetLampStatus(&lrm_LEDState, LRM_LAMP_ALL)) { //lrm_ControlSts(STATUS_LRM_DataShift); lrm_ShiftData(lrm_LEDState.LRM_value, LRM_LAMP_ALL); //lrm_ControlSts(STATUS_LRM_DataOut); } else { } } else { /*do nothing*/ } }  /*************************************************** lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Function: lrm_ControlSts lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Description: set the working mode of the LRM module(74HC595) lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Parameters: mode : input the working mode lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Returns: TRUE or False lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h $Create & Verlog:$ lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Author:Xueping.Chen Date:2016-11-26 Version:V1.0 ****************************************************/ static U8 lrm_ControlSts(U8 mode) { U8 value = 0;  switch (mode) { case STATUS_LRM_Z_State: /*根据74HC595的真值表来设置(pin79,pin80,pin81)*/ DIO_SetIOSts(INDEX_74HC595_G, STATUS_IOM_HIGH, &value);/*PIN81 -> ALL_G*/ break; case STATUS_LRM_DataShift: /*根据74HC595的真值表来设置(pin79,pin80,pin81)*/ DIO_SetIOSts(INDEX_74HC595_SCK, STATUS_IOM_LOW, &value); /*PIN79 -> SCK*/ DIO_SetIOSts(INDEX_74HC595_G, STATUS_IOM_LOW, &value); /*PIN81 -> ALL_G*/ DIO_SetIOSts(INDEX_74HC595_SCK, STATUS_IOM_HIGH, &value); /*PIN79 -> SCK*/ break; case STATUS_LRM_DataOut: /*根据74HC595的真值表来设置(pin79,pin80,pin81)*/ DIO_SetIOSts(INDEX_74HC595_RCK, STATUS_IOM_HIGH, &value); /*PIN80 -> RCK*/ R_TICK_WaitUS(0,10); DIO_SetIOSts(INDEX_74HC595_RCK, STATUS_IOM_LOW, &value); /*PIN80 -> RCK*/ R_TICK_WaitUS(0,10); break; case STATUS_LRM_DataClr: break; default: break; }  return TRUE; }    /*************************************************** lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Function: lrm_ShiftData lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Description: send the data to the data register lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Parameters: value : the data size : the bytes of the data lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Returns: TRUE or FALSE lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h $Create & Verlog:$ lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Author:Xueping.Chen Date:2016-11-26 Version:V1.0 ****************************************************/ static U8 lrm_ShiftData(PU8 value, U8 size) { U8 k = 0; U8 m = 0; U8 val = 0; U8 level = 0; U8 res = RET_FAIL; LrmClkType_ST clktype; clktype.PullUp = TRUE; clktype.Period = 0;  if ((NULL_PTR == value) || (LRM_LAMP_ALL != size)) { res = RET_INVALID; } else { DIO_SetIOSts(INDEX_DIO_PIN80, STATUS_IOM_LOW, &value); /*PIN80 -> RCK*/ DIO_SetIOSts(INDEX_74HC595_SCK, STATUS_IOM_HIGH, &value); /*PIN79 -> SCK*/ R_TICK_WaitUS(0,10);  for (m = 0; m < size; m++) { val = lrm_LEDState.LRM_value[size - m - 1]; for (k = 0; k < 8; k++) { DIO_SetIOSts(INDEX_74HC595_SCK, STATUS_IOM_LOW, &value); /*PIN79 -> SCK*/  if (val & 0x80) { DIO_SetIOSts(INDEX_74HC595_SEG, STATUS_IOM_HIGH, &level); /*PIN71 -> SER*/ } else { DIO_SetIOSts(INDEX_74HC595_SEG, STATUS_IOM_LOW, &level); /*PIN71 -> SER*/ }  R_TICK_WaitUS(0,10); DIO_SetIOSts(INDEX_74HC595_SCK, STATUS_IOM_HIGH, &value); /*PIN79 -> SCK*/ R_TICK_WaitUS(0,10); val = (val << 1); }  } lrm_ControlSts(STATUS_LRM_DataOut); DIO_SetIOSts(INDEX_74HC595_G, STATUS_IOM_LOW, &value); /*PIN81 -> ALL_G*/ R_TICK_WaitUS(0,10);  res = RET_OK; } return res; }  /*************************************************** lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Function: lrm_ClockGen lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Description: Edge trigger signal of the LRM module lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Parameters: ClkType : the condition of the edge trigger signal lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Returns: TRUE or FALSE lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h $Create & Verlog:$ lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Author:Xueping.Chen Date:2016-11-26 Version:V1.0 ****************************************************/ static U8 lrm_ClockGen(LrmClkType_ST ClkType) { U8 value = 0; U8 res = FALSE;  if (TRUE == ClkType.PullUp) { DIO_SetIOSts(INDEX_74HC595_SCK, STATUS_IOM_LOW, &value); /*PIN79 -> SCK*/ DIO_GPIO_Dlayus(10); DIO_SetIOSts(INDEX_74HC595_SCK, STATUS_IOM_HIGH, &value); /*PIN79 -> SCK*/ DIO_GPIO_Dlayus(10); } else { DIO_SetIOSts(INDEX_74HC595_SCK, STATUS_IOM_HIGH, &value); /*PIN79 -> SCK*/ DIO_GPIO_Dlayus(10); DIO_SetIOSts(INDEX_74HC595_SCK, STATUS_IOM_LOW, &value); /*PIN79 -> SCK*/ DIO_GPIO_Dlayus(10); } res = TRUE; return res; }  /*************************************************** lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Function: LRM_SetLampOnEnable lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Description: the control of the all the lampOn lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Parameters: Enable : enable or disable lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Returns: TRUE or FALSE lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h $Create & Verlog:$ lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Author:Xueping.Chen Date:2016-11-26 Version:V1.0 ****************************************************/ U8 LRM_SetLampOnEnable(BOOL Enable) { U8 status = RET_FAIL; U8 res = 0;  if (FALSE == lrm_InitSts) { status = RET_FAIL; }  else { status = DIO_SetIOSts(INDEX_POWER_LED, Enable, &res); status = DIO_SetIOSts(INDEX_POWER_POINTER, Enable, &res); } return status; }  /*************************************************** lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Function: LRM_GetInitStatus lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Description: Get the status of the LRM module initialized lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Parameters: none lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Returns: TRUE or FALSE lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h $Create & Verlog:$ lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Author:Xueping.Chen Date:2016-11-26 Version:V1.0 ****************************************************/ U8 LRM_GetInitStatus(void) { return lrm_InitSts; }   /*=========================================================================== lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h File Revision History(bottom to top:first revision to last revision) *============================================================================ lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h $Log:$ * lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h Rev: Userid: Date: Description *-------- ---------- --------- ------------------------------ * lrm.c lrm_cfg.h lrm_info.inc lrm_private.h lrm_public.h V1.0 Xueping.Chen 2016-11-26 Initial * *===========================================================================*/
