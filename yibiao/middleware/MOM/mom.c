/***************************************************************************** mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Copyright (C) 2016 ShenZhen Yeedon Media co.,LTD. All rights reserved. * mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h File Name : pwmm.C mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Description :the private datas of the pwmm module. mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Author: Xueping.Chen mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Date: 2016-12-01 ******************************************************************************/ /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr Files for including */ #include "mom_info.inc" static BOOL mom_InitSts =FALSE; /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr MOM初始化状态 默认值为FALSE */ static MOMInfo_ST mom_info[METER_ALL]; /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr MOM信息*/ static U8 mom_ZPD_Done = TRUE; /bin /cmd /dev /etc /git-bash.exe /git-cmd.exe /LICENSE.txt /mingw64 /proc /ReleaseNotes.html /tmp /unins000.dat /unins000.exe /unins000.msg /usr MOM归零*/ static MOMWorkStatus_ENUM mom_workMode = MOTOR_IDLE; static U8 mom_GCount = 0; static U8 mom_state = 0;  /*************************************************** mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Function: MOM_Init mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Description: the initialized of the mom module mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Parameters: none mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Returns: none mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h $Create & Verlog:$ mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Author:Xueping.Chen Date:2016-12-01 Version:V1.0 ****************************************************/ void MOM_Init(void) { U8 i = 0;  for (i = 0; i < METER_ALL; i++) { mom_info[i].Mode = MOTOR_IDLE; mom_info[i].Direct = DIR_REMAIN; mom_info[i].step = 0; }  mom_workMode = MOTOR_IDLE; mom_ZPD_Done = TRUE; mom_GCount = 0; mom_InitSts = ISM_GetInitStatus(); }  /*************************************************** mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Function: MOM_Process_5ms mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Description: the process of the mom module mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Parameters: none mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Returns: none mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h $Create & Verlog:$ mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Author:Xueping.Chen Date:2016-12-01 Version:V1.0 ****************************************************/ void MOM_Process_5ms(void) { static U8 cnt;  if (TRUE == mom_InitSts) { switch(mom_workMode) { case MOTOR_NORMAL: if(1 == mom_state) { mom_state = 2; ISM_SetWorkMode(MOTOR_NORMAL); } else if(2 == mom_state) { cnt ++; if(10 < cnt) { cnt = 0; mom_state = 0; } } break; case MOTOR_SELF_CHECKING: if(1 == mom_state) {  mom_state = 0; ISM_SetWorkMode(MOTOR_NORMAL); } break; case MOTOR_TOZERO: if((0 == mom_state) && (FALSE == mom_ZPD_Done)) { if (ZPD_TIMECNT <= mom_GCount) { mom_ZPD_Done = TRUE; mom_GCount = 0;  } else { mom_GCount++; } } else if(1 == mom_state) { mom_state = 2; ISM_Move_Motors(0,0); ISM_Move_Motors(4,0); } else if(2 == mom_state) { if((1 == ISM_GetWorkStatus(4))  && (1 == ISM_GetWorkStatus(0))) { mom_state = 0; } else { } } else { } break; }  } else { } } /*************************************************** mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Function: MOM_GetInitSts mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Description: get the status of the mom initializing mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Parameters: none mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Returns: TRUE or FALSE mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h $Create & Verlog:$ mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Author:Xueping.Chen Date:2016-12-01 Version:V1.0 ****************************************************/ BOOL MOM_GetInitSts(void) { return mom_InitSts; }  /*************************************************** mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Function: MOM_SetStep mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Description: set the dir and step of the motor mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Parameters: meterIndex: inpuMOMMotorType_ENUMt the index of the motor dir : input the noving direction of the motor step: input the steps of the motor need to move mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Returns: TRUE or FALSE mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h $Create & Verlog:$ mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Author:Xueping.Chen Date:2016-12-01 Version:V1.0 ****************************************************/ U8 MOM_SetStep(MOMMotorType_ENUM meterIndex, S8 dir, U16 step) { U8 res = 0;  if ((METER_ALL <= meterIndex) ||( (DIR_LEFT != dir) && (DIR_REMAIN != dir) && (DIR_RIGHT != dir))) { res = RET_INVALID; } else if (FALSE == mom_InitSts) { res = RET_FAIL; } else { if(0 == mom_state) { mom_info[meterIndex].Direct = dir; mom_info[meterIndex].step = step;  if (dir > 0) { ISM_Move_Motors(Mom_Matrix[meterIndex].IsmCh, step); } else { ISM_Move_Motors(Mom_Matrix[meterIndex].IsmCh, step); }  res = RET_OK; } else { } } return res; }   /*************************************************** mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Function: MOM_GetZpdDone mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Description: motor set zpd status mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Parameters: Status:motor status mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Returns: void mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h $Create & Verlog:$ mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Author:Xueping.Chen Date:2016-12-01 Version:V1.0 ****************************************************/ U8 MOM_GetZpdDone(void) { return mom_ZPD_Done; }  /*************************************************** mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Function: MOM_SetWorkMode mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Description: motor set zpd status mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Parameters: mode:input motor work mode mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Returns: void mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h $Create & Verlog:$ mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Author:liuyingying Date:2017-09-25 Version:V2.0 ****************************************************/ U8 MOM_SetWorkMode(MOMWorkStatus_ENUM mode) {  mom_state = 1; switch (mode)  { case MOTOR_NORMAL: //ISM_SetWorkMode(MOTOR_NORMAL); mom_workMode = mode; break;  case MOTOR_SELF_CHECKING: // ISM_SetWorkMode(MOTOR_SELF_CHECKING); mom_workMode = mode; break;  case MOTOR_TOZERO: if(TRUE== mom_ZPD_Done) { mom_GCount =0; mom_ZPD_Done =FALSE; //ISM_SetWorkMode(MOTOR_TOZERO); mom_workMode = mode; } else { } break; }  return RET_OK; }    /*************************************************** mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Function: MOM_IsReachedDesAngle mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Description: motor set zpd status mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Parameters: channel, input tell SPEED OR TACHO mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Returns: void mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h $Create & Verlog:$ mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Author:liuyingying Date:2017-09-25 Version:V2.0 ****************************************************/ U8 MOM_IsReachedDesAngle(U8 channel) { return ISM_GetWorkStatus(Mom_Matrix[channel].IsmCh); }   /*************************************************** mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Function: MOM_StartZPD_BeforeDeepStandBy mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Description: First do ZPD before main-thread start mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Parameters: channel, input tell SPEED OR TACHO mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Returns: void mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h $Create & Verlog:$ mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Author:liuyingying Date:2017-09-25 Version:V2.0 ****************************************************/ U8 MOM_StartZPD_BeforeDeepStandBy(void) { unsigned char i;   mom_GCount =0; mom_ZPD_Done =FALSE; mom_workMode = MOTOR_TOZERO; ISM_Move_Motors(0,0); ISM_Move_Motors(4,0); ISM_StartZpd(R_ISM_CHANNEL_EN0 | R_ISM_CHANNEL_EN4,FALSE); while (FALSE == ISM_isZPDFinish(R_ISM_CHANNEL_EN0 |R_ISM_CHANNEL_EN4,FALSE)) { WDT_Feed(); } ISM_StopZpd(); mom_ZPD_Done = TRUE; }  /*************************************************** mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Function: MOM_StartLittleZPD mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Description: START LITTLE ZPD mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Parameters: NONE mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Returns: void mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h $Create & Verlog:$ mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Author:liuyingying Date:2017-09-25 Version:V2.0 ****************************************************/  void MOM_StartLittleZPD(void) {  unsigned char i;   mom_GCount =0; mom_ZPD_Done =FALSE; mom_workMode = MOTOR_TOZERO; ISM_Move_Motors(0,0); ISM_Move_Motors(4,0); ISM_StartZpd(R_ISM_CHANNEL_EN0 | R_ISM_CHANNEL_EN4,TRUE); while (FALSE == ISM_isZPDFinish(R_ISM_CHANNEL_EN0 |R_ISM_CHANNEL_EN4,TRUE)) { WDT_Feed(); } ISM_StopZpd(); mom_ZPD_Done = TRUE;  }  /*************************************************** mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Function: MOM_GetCurAngle mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Description: Get Cur Angle mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Parameters: ch,pAngle mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Returns: void mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h $Create & Verlog:$ mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Author:liuyingying Date:2017-09-25 Version:V2.0 ****************************************************/ U8 MOM_GetCurAngle(U8 ch, PU32 pAngle) { if(FALSE == mom_InitSts) { return RET_FAIL; } else if(NULL_PTR == pAngle) { return RET_INVALID; } else { ISM_GetCurAngle(Mom_Matrix[ch].IsmCh,pAngle); return RET_OK; } } /*=========================================================================== mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h File Revision History(bottom to top:first revision to last revision) *============================================================================ mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h $Log:$ * mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h Rev: Userid: Date: Description *-------- ---------- --------- ------------------------------ * mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h V1.0 Xueping.Chen 2016-12-01 Initial mom.c mom_cfg.h mom_info.inc mom_private.h mom_public.h V2.0 liuyingying 2017-09-25 modify *===========================================================================*/
